# Root Taskfile - Orchestrates domain-specific taskfiles
version: '3'

# Include domain-specific taskfiles
includes:
  talos: Taskfile.talos.yaml
  k8s: Taskfile.k8s.yaml
  dev: Taskfile.dev.yaml
  infra: Taskfile.infra.yaml

vars:
  TALOS_NODE: '{{.TALOS_NODE | default "192.168.1.54"}}'
  TALOSCONFIG: './configs/talosconfig'
  KUBECONFIG: './.output/kubeconfig'

tasks:
  # ============================================
  # Default Task
  # ============================================

  default:
    desc: Show available task domains and common commands
    cmds:
      - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - echo "â•‘  Talos Homelab Task Runner                 â•‘"
      - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo ""
      - echo "ğŸ“¦ First time setup:"
      - echo "  task deps:install              - Install all dependencies (Homebrew, Yarn, Tilt, hooks)"
      - echo ""
      - echo "ğŸ“‹ Task domains:"
      - echo "  â€¢ talos:*     - Talos Linux operations (config, bootstrap, health, services)"
      - echo "  â€¢ k8s:*       - Kubernetes operations (kubeconfig, pods, dashboard, audit)"
      - echo "  â€¢ dev:*       - Development tools (linting, formatting, hooks, Tilt)"
      - echo "  â€¢ infra:*     - Infrastructure deployment (monitoring, observability, apps)"
      - echo ""
      - echo "ğŸš€ Common commands:"
      - echo "  task health                    - Check cluster health"
      - echo "  task kubeconfig-merge          - Merge kubeconfig to ~/.kube/config"
      - echo "  task get-pods                  - Get all pods"
      - echo "  task lint                      - Run all linters"
      - echo "  task dev:tilt-up               - Start Tilt development environment"
      - echo "  task infra:deploy-stack        - Deploy complete stack"
      - echo "  task infra:deploy-infra-testing - Deploy UI tools (Headlamp, Kubeview, etc.)"
      - echo ""
      - echo "ğŸ“š List all tasks:"
      - echo "  task --list                    - Show all available tasks"
      - echo "  task --list-all                - Show all tasks with descriptions"
      - echo ""
      - echo "ğŸ’¡ Get help for a specific task:"
      - echo "  task <domain>:<task> --help"

  # ============================================
  # Common Shortcuts (Most Frequently Used)
  # ============================================

  health:
    desc: Check Talos cluster health
    cmds:
      - task: talos:health

  dashboard:
    desc: Open Talos dashboard
    cmds:
      - task: talos:dashboard

  kubeconfig:
    desc: Download kubeconfig from Talos
    cmds:
      - task: k8s:kubeconfig

  kubeconfig-merge:
    desc: Merge kubeconfig to ~/.kube/config (enables kubectl/kubectx)
    cmds:
      - task: k8s:kubeconfig-merge

  get-pods:
    desc: Get all pods in all namespaces
    cmds:
      - task: k8s:get-pods

  get-nodes:
    desc: Get Kubernetes nodes
    cmds:
      - task: k8s:get-nodes

  provision:
    desc: Complete provisioning workflow for a fresh node
    cmds:
      - task: talos:provision

  scripts:
    desc: List all available scripts organized by namespace/stack
    cmds:
      - ./scripts/list-scripts.sh {{.CLI_ARGS}}

  scripts:run:
    desc: Interactive script runner (requires fzf)
    cmds:
      - ./scripts/list-scripts.sh --run

  tdarr:
    desc: Show Tdarr worker cache dashboard
    cmds:
      - ./applications/tdarr/scripts/tdarr-dashboard.sh {{.CLI_ARGS}}

  # ============================================
  # Dependencies & Setup
  # ============================================

  deps:install:
    desc: Install all dependencies (Homebrew, Yarn, Tilt, git hooks)
    cmds:
      - echo "ğŸš€ Installing all project dependencies..."
      - echo ""
      - task: _check-homebrew
      - task: _install-brew-deps
      - task: _install-yarn-deps
      - task: _install-tilt
      - task: _install-hooks
      - echo ""
      - echo "âœ… All dependencies installed successfully!"
      - echo ""
      - echo "ğŸ“¦ Installed:"
      - echo "  âœ“ Homebrew packages (kubectl, kustomize, helm, flux, talosctl, etc.)"
      - echo "  âœ“ Node packages (markdownlint, prettier)"
      - echo "  âœ“ Tilt (local development tool)"
      - echo "  âœ“ Git hooks (lefthook)"
      - echo ""
      - echo "ğŸ¯ Next steps:"
      - echo "  1. Provision cluster - task provision"
      - echo "  2. Merge kubeconfig - task kubeconfig-merge"
      - echo "  3. Deploy stack - task infra:deploy-stack"
      - echo "  4. Start development - task dev:tilt-up"

  _check-homebrew:
    internal: true
    cmds:
      - |
        if ! command -v brew &> /dev/null; then
          echo "âŒ Homebrew not installed. Install from https://brew.sh"
          exit 1
        fi
        echo "âœ… Homebrew found: $(brew --version | head -1)"

  _install-brew-deps:
    internal: true
    cmds:
      - |
        echo "ğŸ“¦ Installing Homebrew packages from Brewfile..."
        brew bundle --file=Brewfile
        echo "âœ… Homebrew packages installed"

  _install-yarn-deps:
    internal: true
    cmds:
      - |
        if ! command -v yarn &> /dev/null; then
          echo "âš ï¸  Yarn not found, installing..."
          brew install yarn
        fi
        echo "ğŸ“¦ Installing Node packages..."
        yarn install
        echo "âœ… Node packages installed"

  _install-tilt:
    internal: true
    cmds:
      - |
        if ! command -v tilt &> /dev/null; then
          echo "ğŸ“¦ Installing Tilt..."
          brew install tilt-dev/tap/tilt
          echo "âœ… Tilt installed: $(tilt version)"
        else
          echo "âœ… Tilt already installed: $(tilt version)"
        fi

  _install-hooks:
    internal: true
    cmds:
      - |
        if ! command -v lefthook &> /dev/null; then
          echo "âŒ Lefthook not found. Should have been installed via Brewfile."
          exit 1
        fi
        echo "ğŸ“¦ Installing git hooks..."
        lefthook install
        echo "âœ… Git hooks installed"

  setup:
    desc: Alias for deps:install
    cmds:
      - task: deps:install

  lint:
    desc: Run all linters
    cmds:
      - task: dev:lint

  format:
    desc: Format all code
    cmds:
      - task: dev:format

  validate:
    desc: Validate all infrastructure manifests
    cmds:
      - task: dev:validate

  ci:
    desc: Run full CI pipeline locally (lint + format + validate)
    cmds:
      - task: dev:ci

  deploy-stack:
    desc: Deploy complete observability and monitoring stack
    cmds:
      - task: infra:deploy-stack

  audit:
    desc: Generate comprehensive cluster audit report
    cmds:
      - task: k8s:audit

  dashboard-arr:
    desc: Show ARR stack dashboard with real-time status
    cmds:
      - task: infra:dashboard-arr-stack

  flux-suspend:
    desc: Suspend Flux reconciliation (enables manual control)
    cmds:
      - task: k8s:flux-suspend

  flux-resume:
    desc: Resume Flux reconciliation (re-enables GitOps)
    cmds:
      - task: k8s:flux-resume

  flux-status:
    desc: Show Flux reconciliation status
    cmds:
      - task: k8s:flux-status

  # ============================================
  # Cleanup Tasks
  # ============================================

  clean:
    desc: Remove generated/output files only
    cmds:
      - rm -rf .output
      - echo "âœ… Cleaned up generated files"

  clean-all:
    desc: Remove ALL configs including Talos configs (CAREFUL!)
    cmds:
      - rm -rf .output configs
      - echo "âœ… All configs and output removed"
    prompt: This will remove ALL Talos configuration files. Continue?

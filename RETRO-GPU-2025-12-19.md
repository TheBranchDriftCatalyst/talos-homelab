# GPU Failure Retrospective - talos02-gpu
**Date**: 2025-12-19
**Node**: talos02-gpu (192.168.1.144)
**Status**: GPU NOT FUNCTIONAL - Investigation Ongoing

## Timeline

| Date/Time | Event |
|-----------|-------|
| Dec 15, 13:23 | `f71f362` - Node provisioned with i915 extension on Talos 1.11.1 |
| Dec 15, 13:34 | `a2787e3` - Intel GPU device plugin deployed |
| Dec 15, 15:47 | `b3dce5f` - GPU test jobs added |
| **Dec 16, 16:25** | `9337a89` - **GPU VERIFIED WORKING** - "Intel Arc QSV AV1 encoding working" |
| Dec 17-18 | VPN gateway, SQLite migration, various infrastructure work |
| Dec 18 | Network slowness investigation - **NODE REBOOTS** |
| **Dec 19, 13:10** | `39d4507` - First GPU fix attempt (supplementalGroups) |
| Dec 19, 13:17 | `98bdc5f` - Second fix attempt (privileged mode) |
| Dec 19, 13:21 | `7184320` - Third fix (remove device plugin request) |
| Dec 19, 14:38 | TALOS-707 retrospective task created |
| Dec 19, afternoon | Upgraded to Talos 1.12.0-rc.1 with xe driver - **STILL BROKEN** |
| **Dec 19, 23:05** | Rolled back to Talos 1.11.1 + i915 - **GPU STILL WEDGED** |

## What Was Working (Dec 16)

From commit `9337a89`:
```
Intel Arc QSV AV1 encoding working with:
- av1_qsv encoder at quality 23/24
- 10 GPU workers active
- ~35-65% compression ratio
- Zero errors
```

**Original working configuration:**
- Talos v1.11.1
- `siderolabs/i915` extension
- NO kernel args
- GPU device plugin requesting `gpu.intel.com/i915`

## What Broke

After node reboots (during network troubleshooting), the i915 driver started failing:
```
i915 0000:00:02.0: [drm] *ERROR* Failed to initialize GPU, declaring it wedged!
```

## Investigation Summary

### Hardware
- **Model**: ASUS NUC 15 Pro (RNUC15U5)
- **CPU**: Intel Core Ultra 5 225H (Arrow Lake-H)
- **GPU**: Intel Arc 130T (integrated Meteor Lake iGPU, device ID 7d51)

### Driver Situation
| Driver | Talos Version | Result |
|--------|---------------|--------|
| i915 | 1.11.1 | Was working, now "GPU wedged" after reboot |
| xe | 1.12.0-rc.1 | GSC firmware timeout (-ETIME), no /dev/dri |

### xe Driver Error
```
xe 0000:00:02.0: [drm] Found meteorlake (device ID 7d51) integrated display version 14.00 stepping D0
xe 0000:00:02.0: [drm] Finished loading DMC firmware i915/mtl_dmc.bin (v2.23)
xe 0000:00:02.0: [drm] Tile0: GT0: Using GuC firmware from i915/mtl_guc_70.bin version 70.53.0
xe 0000:00:02.0: [drm] *ERROR* Tile0: GT1: hwe gsccs0: emit_wa_job failed (-ETIME)
xe 0000:00:02.0: probe with driver xe failed with error -62
```

## Current State (After Rollback)

- **Node**: talos02-gpu running Talos 1.11.1
- **i915 module**: Loaded
- **/dev/dri**: EXISTS (card0, renderD128)
- **GPU Status**: **WEDGED** - devices exist but GPU initialization failed
- **Error**: `i915 0000:00:02.0: [drm] *ERROR* Failed to initialize GPU, declaring it wedged!`
- **gpu.intel.com/i915**: Shows 4 available (device plugin sees devices)
- **Tdarr**: Running on talos02-gpu, GPU encoders NOT working (VA-API will fail)

## Root Cause Analysis

**Conclusion: Hardware/Firmware State Issue**

The rollback to the exact original configuration (Talos 1.11.1 + i915) produced the **same wedged GPU error**. This proves:

1. The problem is NOT the driver version
2. The problem is NOT kernel arguments
3. The GPU hardware is stuck in a bad state that persists across reboots

**Most Likely Cause**: During the Dec 18 reboots (network troubleshooting), the GPU entered a corrupted firmware state that:
- Survives warm reboots (kernel reloads)
- May require a cold boot (full power cycle) to reset
- Could indicate hardware damage

## Key Questions

1. **Why did i915 work before reboot but fail after?**
   - Was there GPU state that got lost on reboot?
   - BIOS/firmware interaction?
   - Did something else change during the reboot?

2. **Was GPU actually working on Dec 16, or was it a false positive?**
   - Commit claims 10 GPU workers with QSV AV1 encoding
   - Need to verify this wasn't software fallback

3. **Can we rollback to the working state?**
   - Original config: Talos 1.11.1 + i915 extension
   - But i915 gives "GPU wedged" now...

## Rollback Options

### Option 1: Rollback to Talos 1.11.1 + i915
```bash
# Regenerate original schematic (i915 only)
curl -X POST --data-binary @- https://factory.talos.dev/schematics <<'EOF'
customization:
  systemExtensions:
    officialExtensions:
      - siderolabs/i915
      - siderolabs/intel-ucode
EOF

# Downgrade node
talosctl -n 192.168.1.144 upgrade --image factory.talos.dev/installer/<SCHEMATIC_ID>:v1.11.1 --preserve=true
```

**Risk**: i915 may still give "GPU wedged" error

### Option 2: Wait for Talos 1.12 Stable
The xe driver has known GSC timeout issues with Meteor Lake. Waiting for:
- Talos 1.12.0 stable release
- Upstream xe driver fixes

### Option 3: Hardware investigation
- Check BIOS settings for GPU
- Try a cold boot (full power cycle) vs warm reboot
- Check if iGPU is enabled in BIOS

## Schematic History

### Original (Working - Dec 15-16)
```yaml
# Schematic for Talos 1.11.1
customization:
  systemExtensions:
    officialExtensions:
      - siderolabs/i915
      - siderolabs/intel-ucode
```

### Current (Not Working - Dec 19)
```yaml
# Schematic for Talos 1.12.0-rc.1
customization:
  extraKernelArgs:
    - xe.force_probe=7d51
    - i915.force_probe=!7d51
    - module_blacklist=i915
    - intel_idle.max_cstate=0
    - processor.max_cstate=0
  systemExtensions:
    officialExtensions:
      - siderolabs/xe
      - siderolabs/i915  # for firmware only
      - siderolabs/intel-ucode
```

## Upstream Issues

- xe driver GSC timeout: https://gitlab.freedesktop.org/drm/xe/kernel/-/issues/2025
- Meteor Lake random freezes: https://bbs.archlinux.org/viewtopic.php?id=308313

## Action Items

- [x] Try rollback to Talos 1.11.1 + i915 - **DONE, STILL BROKEN** (GPU wedged)
- [ ] **PRIORITY: Try cold boot** (full power off, unplug power for 30s) - may reset GPU firmware
- [ ] Check BIOS settings for iGPU
- [ ] Monitor upstream xe driver for fixes
- [ ] Consider using talos01 (if it has GPU) for transcoding

## Related Beads Issues

- TALOS-707 - RETROSPECTIVE: Intel Arc GPU failure
- TALOS-fpp - Epic: Set up talos02-gpu worker node with Intel Arc
- TALOS-cgq - Tdarr AV1 transcoding verified (was closed as working)

---

## Session Close Checklist

- [x] git status
- [x] git add / commit beads changes
- [x] git push
- [x] Try rollback to Talos 1.11.1 - **Completed, GPU still wedged**
- [ ] Cold boot (physical intervention required)

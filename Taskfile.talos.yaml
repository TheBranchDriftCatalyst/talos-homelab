# Taskfile for Talos Linux operations
version: '3'

vars:
  TALOS_NODE: '{{.TALOS_NODE | default "192.168.1.54"}}'
  TALOSCONFIG: './configs/talosconfig'
  CLUSTER_NAME: 'catalyst-cluster'
  CLUSTER_ENDPOINT: 'https://{{.TALOS_NODE}}:6443'
  CONTROLPLANE_CONFIG: './configs/controlplane.yaml'
  WORKER_CONFIG: './configs/worker.yaml'

tasks:
  # ============================================
  # Configuration Generation
  # ============================================

  gen-config:
    desc: Generate fresh Talos configuration files
    cmds:
      - mkdir -p configs
      - talosctl gen config {{.CLUSTER_NAME}} {{.CLUSTER_ENDPOINT}} --output-dir ./configs
      - echo "✅ Configs generated in ./configs/"

  # ============================================
  # Node Provisioning
  # ============================================

  apply-config:
    desc: Apply configuration to Talos node (use -- INSECURE=true for first-time)
    cmds:
      - |
        if [ "{{.INSECURE}}" = "true" ]; then
          talosctl apply-config --insecure --nodes {{.TALOS_NODE}} --file {{.CONTROLPLANE_CONFIG}}
        else
          talosctl --talosconfig {{.TALOSCONFIG}} apply-config --nodes {{.TALOS_NODE}} --file {{.CONTROLPLANE_CONFIG}}
        fi
    vars:
      INSECURE: '{{.INSECURE | default "false"}}'

  bootstrap:
    desc: Bootstrap etcd on the control plane node
    cmds:
      - talosctl --talosconfig {{.TALOSCONFIG}} --nodes {{.TALOS_NODE}} bootstrap
      - echo "✅ Cluster bootstrapped! Waiting for Kubernetes..."
      - sleep 30

  provision:
    desc: Complete provisioning workflow for a fresh node
    cmds:
      - ./scripts/provision.sh

  provision-local:
    desc: Create local Docker-based Talos cluster for testing
    cmds:
      - ./scripts/provision-local.sh

  destroy-local:
    desc: Destroy local Docker-based Talos cluster
    cmds:
      - talosctl cluster destroy --name talos-local
      - echo "✅ Local cluster destroyed"

  # ============================================
  # Cluster Management
  # ============================================

  health:
    desc: Check Talos cluster health
    cmds:
      - talosctl --talosconfig {{.TALOSCONFIG}} --nodes {{.TALOS_NODE}} health --server=false

  version:
    desc: Get Talos version
    cmds:
      - talosctl --talosconfig {{.TALOSCONFIG}} --nodes {{.TALOS_NODE}} version

  dashboard:
    desc: Open Talos dashboard
    cmds:
      - talosctl --talosconfig {{.TALOSCONFIG}} --nodes {{.TALOS_NODE}} dashboard

  # ============================================
  # Services
  # ============================================

  services:
    desc: List all Talos services
    cmds:
      - talosctl --talosconfig {{.TALOSCONFIG}} --nodes {{.TALOS_NODE}} services

  service-logs:
    desc: Get logs for a specific service (use -- SERVICE=kubelet)
    cmds:
      - talosctl --talosconfig {{.TALOSCONFIG}} --nodes {{.TALOS_NODE}} logs {{.SERVICE}}
    vars:
      SERVICE: '{{.SERVICE | default "kubelet"}}'

  logs-follow:
    desc: Follow logs for a service (use -- SERVICE=kubelet)
    cmds:
      - talosctl --talosconfig {{.TALOSCONFIG}} --nodes {{.TALOS_NODE}} logs --follow {{.SERVICE}}
    vars:
      SERVICE: '{{.SERVICE | default "kubelet"}}'

  # ============================================
  # Troubleshooting
  # ============================================

  dmesg:
    desc: View kernel logs
    cmds:
      - talosctl --talosconfig {{.TALOSCONFIG}} --nodes {{.TALOS_NODE}} dmesg

  shell:
    desc: Get interactive shell (limited in Talos)
    cmds:
      - talosctl --talosconfig {{.TALOSCONFIG}} --nodes {{.TALOS_NODE}} shell

  containers:
    desc: List running containers
    cmds:
      - talosctl --talosconfig {{.TALOSCONFIG}} --nodes {{.TALOS_NODE}} containers

  # ============================================
  # Node Operations
  # ============================================

  reboot:
    desc: Reboot the node
    cmds:
      - talosctl --talosconfig {{.TALOSCONFIG}} --nodes {{.TALOS_NODE}} reboot
    prompt: This will reboot the node. Continue?

  shutdown:
    desc: Shutdown the node
    cmds:
      - talosctl --talosconfig {{.TALOSCONFIG}} --nodes {{.TALOS_NODE}} shutdown
    prompt: This will shutdown the node. Continue?

  reset:
    desc: Reset the node (DESTRUCTIVE - wipes all data)
    cmds:
      - talosctl --talosconfig {{.TALOSCONFIG}} --nodes {{.TALOS_NODE}} reset --graceful=false --reboot
    prompt: This will WIPE ALL DATA on the node. Are you sure?

  upgrade:
    desc: Upgrade Talos (use -- VERSION=v1.11.1)
    cmds:
      - >-
        talosctl --talosconfig {{.TALOSCONFIG}} --nodes {{.TALOS_NODE}}
        upgrade --image ghcr.io/siderolabs/installer:{{.VERSION}}
    vars:
      VERSION: '{{.VERSION | default "v1.11.1"}}'

  # ============================================
  # Config Management
  # ============================================

  config-merge:
    desc: Merge talosconfig to default location (~/.talos/config)
    cmds:
      - talosctl config merge {{.TALOSCONFIG}}
      - echo "✅ Config merged to ~/.talos/config"

  config-info:
    desc: Show current Talos config info
    cmds:
      - talosctl --talosconfig {{.TALOSCONFIG}} config info

  # ============================================
  # Network Troubleshooting
  # ============================================

  ping:
    desc: Ping the Talos node
    cmds:
      - ping -c 4 {{.TALOS_NODE}}

  check-api:
    desc: Check if Talos API is responding
    cmds:
      - curl -k https://{{.TALOS_NODE}}:50000/version 2>&1 | head -10

  # ============================================
  # Etcd Operations
  # ============================================

  etcd-members:
    desc: List etcd members
    cmds:
      - talosctl --talosconfig {{.TALOSCONFIG}} --nodes {{.TALOS_NODE}} etcd members

  etcd-status:
    desc: Get etcd status
    cmds:
      - talosctl --talosconfig {{.TALOSCONFIG}} --nodes {{.TALOS_NODE}} etcd status

---
# LobeChat Server Mode - Modern ChatGPT-like UI with database backend
# Requires: PostgreSQL (scratch-postgres), MinIO
#
# TODO: Move secrets to ExternalSecrets/OnePassword (see beads task)
apiVersion: v1
kind: ConfigMap
metadata:
  name: lobe-chat-config
  namespace: catalyst-llm
data:
  # Database
  DATABASE_DRIVER: "node"
  # S3 Storage
  S3_ENDPOINT: "http://minio.minio.svc.cluster.local:80"
  S3_BUCKET: "lobechat"
  S3_ENABLE_PATH_STYLE: "1"
  S3_PUBLIC_DOMAIN: "http://minio.minio.svc.cluster.local:80"
  # App config
  APP_URL: "http://lobe.talos00"
  # NextAuth callback URL (must be accessible from browser AND server)
  NEXTAUTH_URL: "http://lobe.talos00/api/auth"
  NEXT_PUBLIC_ENABLE_NEXT_AUTH: "1"
  NEXT_PUBLIC_SERVICE_MODE: "server"
  # Providers - enable what you need
  ENABLED_OLLAMA: "1"
  OLLAMA_PROXY_URL: "http://llm-proxy:8080"
  # Enable OpenAI-compatible for HuggingFace router
  ENABLED_OPENAI: "1"
  # Disable others
  ENABLED_ANTHROPIC: "0"
  ENABLED_GOOGLE: "0"
---
# TEMPORARY hardcoded secret - move to ExternalSecrets later
# See beads task for proper OnePassword integration
apiVersion: v1
kind: Secret
metadata:
  name: lobe-chat-secrets
  namespace: catalyst-llm
  annotations:
    # Mark as temporary - should be moved to ExternalSecrets
    catalyst.io/temporary: "true"
    catalyst.io/todo: "Move to ExternalSecrets with OnePassword"
type: Opaque
stringData:
  # KEY_VAULTS_SECRET - encrypts sensitive user data
  KEY_VAULTS_SECRET: "YP6h/1pCGk6dfs9YQ6x27pKUJ7+94sbvUusTsbUwunk="
  # NextAuth secret for session encryption
  NEXT_AUTH_SECRET: "vQSeiwMoBnv9elw577K8yBcHz/wbisZOQDGNBTQkOQQ="
  # PostgreSQL connection (using existing scratch-postgres app user)
  DATABASE_URL: "postgresql://scratch_app:scratch-app-password@scratch-postgres-rw.scratch.svc.cluster.local:5432/lobechat?sslmode=disable"
  # MinIO/S3 credentials
  S3_ACCESS_KEY_ID: "minio"
  S3_SECRET_ACCESS_KEY: "minio123"
  # HuggingFace token - optional, users can add their own in UI
  # OPENAI_API_KEY: ""
  # Authentik OIDC
  NEXT_AUTH_SSO_PROVIDERS: "authentik"
  AUTH_AUTHENTIK_ID: "a9YOu5LvGsKrkTpKfKJeFVIqL0i9iPxPeVgOeaGf"
  AUTH_AUTHENTIK_SECRET: "72KpBOPThgTElf7hWrWsvTwpmGYe2oA6ADrothiUaaFyXrJ85Uz0Qhk5ItLajvuIYaQx0vmhh2iuPi3Ha7sOpswzTVRXq3fLyVeOCkRCZn5hnfeCnevsLC3XB2wzh9np"
  AUTH_AUTHENTIK_ISSUER: "http://auth.talos00/application/o/lobechat/"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: lobe-chat
  namespace: catalyst-llm
  labels:
    app.kubernetes.io/name: lobe-chat
    app.kubernetes.io/component: frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: lobe-chat
  template:
    metadata:
      labels:
        app: lobe-chat
        app.kubernetes.io/name: lobe-chat
    spec:
      # Route *.talos00 hostnames through Traefik ingress controller
      # This allows internal pod calls to use the same URLs as external browser requests
      hostAliases:
        - ip: "10.102.48.155"  # Traefik ClusterIP
          hostnames:
            - "auth.talos00"
            - "lobe.talos00"
      initContainers:
        # Create S3 bucket before starting
        - name: create-bucket
          image: minio/mc:latest
          env:
            - name: S3_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: lobe-chat-secrets
                  key: S3_ACCESS_KEY_ID
            - name: S3_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: lobe-chat-secrets
                  key: S3_SECRET_ACCESS_KEY
          command:
            - sh
            - -c
            - |
              mc alias set myminio http://minio.minio.svc.cluster.local:80 $S3_ACCESS_KEY_ID $S3_SECRET_ACCESS_KEY
              mc mb myminio/lobechat --ignore-existing
              echo "Bucket ready"
      containers:
        - name: lobe-chat
          # Server mode with database + Authentik OIDC
          image: lobehub/lobe-chat-database:latest
          ports:
            - containerPort: 3210
              name: http
          envFrom:
            - configMapRef:
                name: lobe-chat-config
            - secretRef:
                name: lobe-chat-secrets
          env:
            # OpenAI base URL for HuggingFace router
            - name: OPENAI_PROXY_URL
              value: "https://router.huggingface.co/v1"
          resources:
            requests:
              cpu: 100m
              memory: 512Mi
            limits:
              memory: 1Gi
          livenessProbe:
            httpGet:
              path: /api/auth/providers
              port: 3210
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /api/auth/providers
              port: 3210
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 3
---
apiVersion: v1
kind: Service
metadata:
  name: lobe-chat
  namespace: catalyst-llm
  labels:
    app.kubernetes.io/name: lobe-chat
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 3210
      targetPort: 3210
  selector:
    app: lobe-chat

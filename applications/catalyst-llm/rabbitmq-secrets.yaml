---
# TODO: TALOS-c1c1 - Migrate to 1Password ExternalSecret
# Temporary hardcoded credentials for initial deployment
apiVersion: v1
kind: Secret
metadata:
  name: rabbitmq-credentials
  namespace: catalyst-llm
  labels:
    app.kubernetes.io/name: rabbitmq
type: Opaque
stringData:
  password: turbopookipanda
  erlang-cookie: catalyst-llm-erlang-cookie-2026
---
# RabbitMQ Definitions (queues, exchanges, bindings)
# Applied on startup via loadDefinition
apiVersion: v1
kind: Secret
metadata:
  name: rabbitmq-definitions
  namespace: catalyst-llm
  labels:
    app.kubernetes.io/name: rabbitmq
    app.kubernetes.io/component: definitions
stringData:
  load_definition.json: |
    {
      "vhosts": [
        {"name": "llm"},
        {"name": "agents"}
      ],
      "permissions": [
        {
          "user": "panda",
          "vhost": "llm",
          "configure": ".*",
          "write": ".*",
          "read": ".*"
        },
        {
          "user": "panda",
          "vhost": "agents",
          "configure": ".*",
          "write": ".*",
          "read": ".*"
        }
      ],
      "exchanges": [
        {
          "name": "llm.inference",
          "vhost": "llm",
          "type": "topic",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "llm.priority",
          "vhost": "llm",
          "type": "direct",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "llm.workers",
          "vhost": "llm",
          "type": "fanout",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "llm.dlx",
          "vhost": "llm",
          "type": "fanout",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "agents.registration",
          "vhost": "agents",
          "type": "direct",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "agents.heartbeat",
          "vhost": "agents",
          "type": "fanout",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "agents.commands",
          "vhost": "agents",
          "type": "topic",
          "durable": true,
          "auto_delete": false
        }
      ],
      "queues": [
        {
          "name": "inference.default",
          "vhost": "llm",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-dead-letter-exchange": "llm.dlx",
            "x-message-ttl": 300000
          }
        },
        {
          "name": "inference.llama3",
          "vhost": "llm",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-dead-letter-exchange": "llm.dlx",
            "x-message-ttl": 300000
          }
        },
        {
          "name": "inference.mistral",
          "vhost": "llm",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-dead-letter-exchange": "llm.dlx",
            "x-message-ttl": 300000
          }
        },
        {
          "name": "inference.qwen",
          "vhost": "llm",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-dead-letter-exchange": "llm.dlx",
            "x-message-ttl": 300000
          }
        },
        {
          "name": "inference.dolphin",
          "vhost": "llm",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-dead-letter-exchange": "llm.dlx",
            "x-message-ttl": 300000
          }
        },
        {
          "name": "priority.high",
          "vhost": "llm",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-max-priority": 10,
            "x-dead-letter-exchange": "llm.dlx",
            "x-message-ttl": 60000
          }
        },
        {
          "name": "priority.low",
          "vhost": "llm",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-max-priority": 10,
            "x-dead-letter-exchange": "llm.dlx",
            "x-message-ttl": 600000
          }
        },
        {
          "name": "workers.heartbeat",
          "vhost": "llm",
          "durable": false,
          "auto_delete": true,
          "arguments": {
            "x-message-ttl": 30000
          }
        },
        {
          "name": "dead-letter",
          "vhost": "llm",
          "durable": true,
          "auto_delete": false,
          "arguments": {}
        },
        {
          "name": "registration.control-plane",
          "vhost": "agents",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-message-ttl": 300000
          }
        },
        {
          "name": "heartbeat.control-plane",
          "vhost": "agents",
          "durable": false,
          "auto_delete": false,
          "arguments": {
            "x-message-ttl": 60000
          }
        }
      ],
      "bindings": [
        {
          "source": "llm.inference",
          "vhost": "llm",
          "destination": "inference.default",
          "destination_type": "queue",
          "routing_key": "#"
        },
        {
          "source": "llm.inference",
          "vhost": "llm",
          "destination": "inference.llama3",
          "destination_type": "queue",
          "routing_key": "llama3.*"
        },
        {
          "source": "llm.inference",
          "vhost": "llm",
          "destination": "inference.mistral",
          "destination_type": "queue",
          "routing_key": "mistral.*"
        },
        {
          "source": "llm.inference",
          "vhost": "llm",
          "destination": "inference.qwen",
          "destination_type": "queue",
          "routing_key": "qwen*"
        },
        {
          "source": "llm.inference",
          "vhost": "llm",
          "destination": "inference.dolphin",
          "destination_type": "queue",
          "routing_key": "dolphin*"
        },
        {
          "source": "llm.priority",
          "vhost": "llm",
          "destination": "priority.high",
          "destination_type": "queue",
          "routing_key": "high"
        },
        {
          "source": "llm.priority",
          "vhost": "llm",
          "destination": "priority.low",
          "destination_type": "queue",
          "routing_key": "low"
        },
        {
          "source": "llm.workers",
          "vhost": "llm",
          "destination": "workers.heartbeat",
          "destination_type": "queue",
          "routing_key": ""
        },
        {
          "source": "llm.dlx",
          "vhost": "llm",
          "destination": "dead-letter",
          "destination_type": "queue",
          "routing_key": ""
        },
        {
          "source": "agents.registration",
          "vhost": "agents",
          "destination": "registration.control-plane",
          "destination_type": "queue",
          "routing_key": "register"
        },
        {
          "source": "agents.registration",
          "vhost": "agents",
          "destination": "registration.control-plane",
          "destination_type": "queue",
          "routing_key": "deregister"
        },
        {
          "source": "agents.heartbeat",
          "vhost": "agents",
          "destination": "heartbeat.control-plane",
          "destination_type": "queue",
          "routing_key": ""
        }
      ]
    }

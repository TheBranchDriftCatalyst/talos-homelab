---
# Worker script ConfigMap for LLM Scaler
# Contains the llm-worker.sh script that manages AWS EC2 instances
apiVersion: v1
kind: ConfigMap
metadata:
  name: llm-worker-script
  namespace: catalyst-llm
  labels:
    app.kubernetes.io/name: llm-scaler
    app.kubernetes.io/component: worker-script
data:
  llm-worker.sh: |
    #!/bin/bash
    # LLM Worker Control Script (Kubernetes version)
    # This is a simplified version for the scaler container
    # Full script at: scripts/hybrid-llm/llm-worker.sh

    set -euo pipefail

    AWS_REGION="${AWS_REGION:-us-west-2}"
    STATE_FILE="${STATE_FILE:-/app/.output/worker-state.json}"

    log_info() { echo "[INFO] $1"; }
    log_error() { echo "[ERROR] $1" >&2; }

    get_state() {
      local key="$1"
      if [[ -f "$STATE_FILE" ]]; then
        jq -r --arg key "$key" '.[$key] // empty' "$STATE_FILE" 2>/dev/null || echo ""
      fi
    }

    save_state() {
      local key="$1"
      local value="$2"
      mkdir -p "$(dirname "$STATE_FILE")"
      if [[ -f "$STATE_FILE" ]]; then
        jq --arg key "$key" --arg value "$value" '.[$key] = $value' "$STATE_FILE" > "${STATE_FILE}.tmp"
        mv "${STATE_FILE}.tmp" "$STATE_FILE"
      else
        echo "{\"$key\": \"$value\"}" > "$STATE_FILE"
      fi
    }

    get_instance_status() {
      local instance_id=$(get_state "instance_id")
      if [[ -z "$instance_id" ]]; then
        echo "not_provisioned"
        return
      fi
      aws ec2 describe-instances \
        --instance-ids "$instance_id" \
        --query 'Reservations[0].Instances[0].State.Name' \
        --output text \
        --region "$AWS_REGION" 2>/dev/null || echo "not_found"
    }

    cmd_status() {
      local status=$(get_instance_status)
      echo "{\"status\": \"$status\"}"
    }

    cmd_start() {
      local instance_id=$(get_state "instance_id")
      local status=$(get_instance_status)

      if [[ "$status" == "not_provisioned" ]]; then
        log_error "Worker not provisioned"
        exit 1
      fi

      if [[ "$status" == "running" ]]; then
        log_info "Already running"
        exit 0
      fi

      log_info "Starting instance: $instance_id"
      aws ec2 start-instances --instance-ids "$instance_id" --region "$AWS_REGION" > /dev/null
      aws ec2 wait instance-running --instance-ids "$instance_id" --region "$AWS_REGION"
      log_info "Started"
    }

    cmd_stop() {
      local instance_id=$(get_state "instance_id")
      local status=$(get_instance_status)

      if [[ "$status" != "running" ]]; then
        log_info "Not running"
        exit 0
      fi

      log_info "Stopping instance: $instance_id"
      aws ec2 stop-instances --instance-ids "$instance_id" --region "$AWS_REGION" > /dev/null
      aws ec2 wait instance-stopped --instance-ids "$instance_id" --region "$AWS_REGION"
      log_info "Stopped"
    }

    case "${1:-status}" in
      start)  cmd_start ;;
      stop)   cmd_stop ;;
      status) cmd_status ;;
      *)
        echo "Usage: $0 {start|stop|status}"
        exit 1
        ;;
    esac

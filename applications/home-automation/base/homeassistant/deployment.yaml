---
# Home Assistant - Smart Home Automation Platform
# TODO: Add Bluetooth USB passthrough (TALOS-xxxx)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: homeassistant
  labels:
    app: homeassistant
    app.kubernetes.io/name: homeassistant
    app.kubernetes.io/part-of: home-automation
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: homeassistant
  template:
    metadata:
      labels:
        app: homeassistant
        app.kubernetes.io/name: homeassistant
      annotations:
        # Velero backup
        backup.velero.io/backup-volumes: "config"
    spec:
      # Host network for mDNS discovery and integrations
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet

      # Init container to set up base configuration if not exists
      initContainers:
        - name: init-config
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              if [ ! -f /config/configuration.yaml ]; then
                echo "No configuration.yaml found, copying base config..."
                cp /config-base/configuration.yaml /config/configuration.yaml
              else
                # Ensure trusted_proxies config exists
                if ! grep -q "trusted_proxies" /config/configuration.yaml; then
                  echo "Adding trusted_proxies config..."
                  cat >> /config/configuration.yaml << 'EOF'

              # Reverse proxy configuration (Traefik)
              http:
                use_x_forwarded_for: true
                trusted_proxies:
                  - 10.0.0.0/8
                  - 172.16.0.0/12
                  - 192.168.0.0/16
              EOF
                fi
              fi
              # Ensure required files exist
              touch /config/automations.yaml /config/scripts.yaml /config/scenes.yaml
              mkdir -p /config/themes
          volumeMounts:
            - name: config
              mountPath: /config
            - name: config-base
              mountPath: /config-base

      containers:
        - name: homeassistant
          image: ghcr.io/home-assistant/home-assistant:stable
          imagePullPolicy: IfNotPresent

          env:
            - name: TZ
              value: "America/Los_Angeles"

          ports:
            - name: http
              containerPort: 8123
              protocol: TCP

          volumeMounts:
            - name: config
              mountPath: /config
            # TODO: Uncomment for Bluetooth dongle support (TALOS-xxxx)
            # - name: usb
            #   mountPath: /dev/bus/usb
            # - name: dbus
            #   mountPath: /run/dbus
            #   readOnly: true

          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 120
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5

          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          resources:
            requests:
              cpu: 100m
              memory: 512Mi

        # Matter Server sidecar for Matter/Thread device support
        - name: matter-server
          image: ghcr.io/home-assistant-libs/python-matter-server:stable
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true  # Required for Matter commissioning
          env:
            - name: TZ
              value: "America/Los_Angeles"
          ports:
            - name: matter-ws
              containerPort: 5580
              protocol: TCP
          volumeMounts:
            - name: matter-data
              mountPath: /data
          resources:
            requests:
              cpu: 50m
              memory: 128Mi

      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: homeassistant-config-nfs
        - name: config-base
          configMap:
            name: homeassistant-config
        - name: matter-data
          persistentVolumeClaim:
            claimName: matter-server-data-nfs
        # TODO: Uncomment for Bluetooth dongle support (TALOS-xxxx)
        # - name: usb
        #   hostPath:
        #     path: /dev/bus/usb
        #     type: Directory
        # - name: dbus
        #   hostPath:
        #     path: /run/dbus
        #     type: Directory

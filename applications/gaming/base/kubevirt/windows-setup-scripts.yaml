---
# ConfigMap containing Windows setup/optimization scripts
# Mounted as a disk in the VM - appears as a drive letter in Windows
# Run the scripts from that drive after first boot
apiVersion: v1
kind: ConfigMap
metadata:
  name: catalyst-windows-devsauce
  labels:
    app: windows-gameserver
data:
  optimize-server.bat: |
    @echo off
    echo ============================================
    echo  Windows Dedicated Server Optimization
    echo  Conan Exiles - Talos Homelab
    echo ============================================
    echo.

    :: Check for admin
    net session >nul 2>&1
    if %errorLevel% neq 0 (
        echo ERROR: Run this script as Administrator!
        pause
        exit /b 1
    )

    echo [1/10] Setting High Performance power plan...
    powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
    powercfg /change standby-timeout-ac 0
    powercfg /change monitor-timeout-ac 0
    powercfg /change hibernate-timeout-ac 0

    echo [2/10] Disabling unnecessary services...
    sc config WSearch start=disabled >nul 2>&1
    net stop WSearch >nul 2>&1
    sc config SysMain start=disabled >nul 2>&1
    net stop SysMain >nul 2>&1
    sc config DiagTrack start=disabled >nul 2>&1
    net stop DiagTrack >nul 2>&1
    sc config Spooler start=disabled >nul 2>&1
    net stop Spooler >nul 2>&1
    sc config MapsBroker start=disabled >nul 2>&1
    net stop MapsBroker >nul 2>&1
    sc config wisvc start=disabled >nul 2>&1
    net stop wisvc >nul 2>&1

    echo [3/10] Disabling Windows Defender real-time monitoring...
    powershell -Command "Set-MpPreference -DisableRealtimeMonitoring $true" >nul 2>&1

    echo [4/10] Disabling VBS / Memory Integrity...
    bcdedit /set hypervisorlaunchtype off >nul 2>&1
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\DeviceGuard\Scenarios\HypervisorEnforcedCodeIntegrity" /v Enabled /t REG_DWORD /d 0 /f >nul 2>&1

    echo [5/10] Configuring firewall rules...
    netsh advfirewall firewall add rule name="Conan Game UDP" dir=in action=allow protocol=UDP localport=7777,7778,27015 >nul 2>&1
    netsh advfirewall firewall add rule name="Conan RCON" dir=in action=allow protocol=TCP localport=25575 >nul 2>&1
    netsh advfirewall firewall add rule name="Conan Web" dir=in action=allow protocol=TCP localport=80 >nul 2>&1
    netsh advfirewall firewall add rule name="RDP Access" dir=in action=allow protocol=TCP localport=3389 >nul 2>&1

    echo [6/10] Preventing auto-reboot from Windows Update...
    reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" /v NoAutoRebootWithLoggedOnUsers /t REG_DWORD /d 1 /f >nul 2>&1
    reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" /v AUOptions /t REG_DWORD /d 2 /f >nul 2>&1

    echo [7/10] Disabling visual effects for performance...
    reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" /v VisualFXSetting /t REG_DWORD /d 2 /f >nul 2>&1
    reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" /v EnableTransparency /t REG_DWORD /d 0 /f >nul 2>&1

    echo [8/10] Disabling notifications and Game DVR...
    reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\PushNotifications" /v ToastEnabled /t REG_DWORD /d 0 /f >nul 2>&1
    reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\GameDVR" /v AppCaptureEnabled /t REG_DWORD /d 0 /f >nul 2>&1
    reg add "HKCU\System\GameConfigStore" /v GameDVR_Enabled /t REG_DWORD /d 0 /f >nul 2>&1

    echo [9/10] Setting DNS to Google...
    netsh interface ip set dns "Ethernet Instance 0" static 8.8.8.8 >nul 2>&1
    netsh interface ip add dns "Ethernet Instance 0" 8.8.4.4 index=2 >nul 2>&1

    echo [10/10] Enabling Remote Desktop...
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f >nul 2>&1
    netsh advfirewall firewall set rule group="remote desktop" new enable=Yes >nul 2>&1

    echo.
    echo ============================================
    echo  Optimization complete!
    echo  Reboot recommended to apply all changes.
    echo ============================================
    pause

  setup-autologin.bat: |
    @echo off
    echo ============================================
    echo  Auto-Login Setup
    echo ============================================
    echo.

    net session >nul 2>&1
    if %errorLevel% neq 0 (
        echo ERROR: Run this script as Administrator!
        pause
        exit /b 1
    )

    set /p USERNAME="Enter Windows username: "
    set /p PASSWORD="Enter Windows password: "

    reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v AutoAdminLogon /t REG_SZ /d 1 /f >nul
    reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultUserName /t REG_SZ /d "%USERNAME%" /f >nul
    reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultPassword /t REG_SZ /d "%PASSWORD%" /f >nul

    echo.
    echo Auto-login configured for user: %USERNAME%
    echo The VM will auto-login on next reboot.
    pause

  download-modlist.bat: |
    @echo off
    echo Downloading Conan Exiles mod list...
    curl -o C:\conan-modlist.txt https://raw.githubusercontent.com/TheBranchDriftCatalyst/talos-homelab/main/applications/gaming/base/kubevirt/conan-modlist.txt
    echo.
    echo Mod list saved to C:\conan-modlist.txt
    echo Import this in the Dedicated Server Launcher.
    pause

  mount-backup.bat: |
    @echo off
    echo ============================================
    echo  Mount NFS Backup Drive
    echo  Synology NAS @ 192.168.1.36
    echo ============================================
    echo.

    :: Check for admin
    net session >nul 2>&1
    if %errorLevel% neq 0 (
        echo ERROR: Run this script as Administrator!
        pause
        exit /b 1
    )

    echo [1/3] Enabling NFS client feature...
    powershell -Command "Enable-WindowsOptionalFeature -Online -FeatureName ServicesForNFS-ClientOnly,ClientForNFS-Infrastructure -NoRestart" >nul 2>&1

    echo [2/3] Mounting \\192.168.1.36\backups to B: drive...
    net use B: /delete >nul 2>&1
    mount -o anon \\192.168.1.36\backups B:
    if %errorLevel% neq 0 (
        echo NFS mount failed, trying SMB...
        net use B: \\192.168.1.36\backups /persistent:yes
    )

    echo [3/3] Verifying mount...
    if exist B:\ (
        echo.
        echo SUCCESS: Backup drive mounted at B:\
        echo Configure Conan backup path to B:\conan-backup\
        if not exist B:\conan-backup mkdir B:\conan-backup
    ) else (
        echo.
        echo FAILED: Drive B: not accessible.
        echo Check NAS connectivity: ping 192.168.1.36
    )

    echo.
    pause

  conan-modlist.txt: |
    1823412793
    1815573406
    1705201022
    2474566370
    2752945598
    2686032948
    2688579883
    3350203730
    1928978003
    2411388528
    2095912535
    2723987721
    2279131041
    3425757676
    3622125130
    1369743238
    1444947329
    2744140111
    2762696414
    2050780234
    3248573436
    1976970830
    2384014945
    2597952237
    2854276803
    3216398799
    2982469779
    3086070534
    3362177073
    2977286345
    3066274812
    2376449518
    2994634277
    3326354818
    2010870025
    2674337782
    933782986
    3073504073
    3484896698
    2914309509
    3221682299
    2799362941
    3043356654
    2772364595
    2963680793
    2794943951
    2961309071
    2300463941
    3008860121
    2250037083
    2871328013
    3261081547
    2677532697
    1629644846
    3463902338
    3373599765
    3036057084
    2850232250
    2847709656
    2886779102
    3036058836
    2671265327

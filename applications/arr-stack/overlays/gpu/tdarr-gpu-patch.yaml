---
# Tdarr GPU Patch - Intel QuickSync hardware transcoding
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tdarr
spec:
  template:
    spec:
      # CRITICAL: Add video group (44) for GPU device access
      securityContext:
        supplementalGroups:
          - 44  # video group - required for /dev/dri access
          - 104 # render group - some systems need this too
      # Prefer GPU nodes but don't require them
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: intel.feature.node.kubernetes.io/gpu
                    operator: In
                    values:
                      - 'true'
      containers:
        - name: tdarr
          # NOTE: Do NOT request gpu.intel.com/i915 - the device plugin mounts devices read-only
          # Instead use hostPath mount with privileged mode for full GPU access
          resources:
            limits:
              cpu: '12'
              memory: 24Gi
            requests:
              cpu: '4'
              memory: 16Gi
          # GPU environment variables for Tdarr/FFmpeg
          env:
            - name: NVIDIA_VISIBLE_DEVICES
              value: 'void'  # Disable NVIDIA (not used)
          # securityContext for GPU access - privileged required for full /dev/dri access
          securityContext:
            privileged: true
          volumeMounts:
            - name: dri
              mountPath: /dev/dri
      volumes:
        - name: dri
          hostPath:
            path: /dev/dri
            type: Directory

---
# Migration Job for arr-stack
# Copies config files and backups from staging PVC to app config PVCs
#
# Usage:
# 1. Stage source data to arr-migration-staging PVC using kubectl cp
# 2. Apply this job: kubectl apply -f job.yaml
# 3. Monitor: kubectl logs -f job/arr-migration -n media
#
# The staging PVC should contain:
#   /arrs/sonarr/  - Sonarr config, asp/, Backups/
#   /arrs/radarr/  - Radarr config, asp/, Backups/
#   /prowlarr/     - Prowlarr config, asp/, Backups/
apiVersion: batch/v1
kind: Job
metadata:
  name: arr-migration
  labels:
    app.kubernetes.io/name: arr-migration
    app.kubernetes.io/component: migration
spec:
  ttlSecondsAfterFinished: 3600  # Clean up after 1 hour
  backoffLimit: 2
  template:
    metadata:
      labels:
        app.kubernetes.io/name: arr-migration
    spec:
      restartPolicy: OnFailure
      # Tolerate control-plane taint (sonarr/radarr PVCs are on talos00)
      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
      containers:
        - name: migrate
          image: busybox:1.36
          command:
            - /bin/sh
            - -c
            - |
              echo "Starting arr-stack migration..."
              chmod +x /scripts/migrate.sh /scripts/validate.sh
              /scripts/migrate.sh all
              echo ""
              /scripts/validate.sh
          volumeMounts:
            - name: scripts
              mountPath: /scripts
            - name: source
              mountPath: /source
              readOnly: true
            - name: target-sonarr
              mountPath: /target/sonarr
            - name: target-radarr
              mountPath: /target/radarr
            - name: target-prowlarr
              mountPath: /target/prowlarr
      volumes:
        - name: scripts
          configMap:
            name: arr-migration-scripts
            defaultMode: 0755
        # Staging PVC with source data (populated via kubectl cp)
        - name: source
          persistentVolumeClaim:
            claimName: arr-migration-staging
        # Target app config PVCs
        - name: target-sonarr
          persistentVolumeClaim:
            claimName: sonarr-config
        - name: target-radarr
          persistentVolumeClaim:
            claimName: radarr-config
        - name: target-prowlarr
          persistentVolumeClaim:
            claimName: prowlarr-config
---
# Staging PVC for migration source data
# This is temporary - can be deleted after migration
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: arr-migration-staging
  labels:
    app.kubernetes.io/name: arr-migration
    app.kubernetes.io/component: staging
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: local-path
  resources:
    requests:
      storage: 2Gi  # Enough for configs and backups (not MediaCover)

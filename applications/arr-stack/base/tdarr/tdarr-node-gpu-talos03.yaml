---
# Tdarr GPU Worker for talos03 (AMD Radeon Vega - VAAPI)
# Provides hardware-accelerated transcoding via AMD VAAPI
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tdarr-node-gpu-talos03
  labels:
    app: tdarr-node-gpu
    app.kubernetes.io/name: tdarr-node-gpu-talos03
    app.kubernetes.io/part-of: arr-stack
    gpu-type: amd-vaapi
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: tdarr-node-gpu-talos03
  template:
    metadata:
      labels:
        app: tdarr-node-gpu-talos03
        app.kubernetes.io/name: tdarr-node-gpu-talos03
        gpu-type: amd-vaapi
    spec:
      # Run only on talos03
      nodeSelector:
        kubernetes.io/hostname: talos03

      # Run as privileged to access GPU devices
      securityContext:
        fsGroup: 44  # video group

      containers:
        - name: tdarr-node
          image: ghcr.io/haveagitgat/tdarr_node:2.58.02
          imagePullPolicy: IfNotPresent

          securityContext:
            privileged: true  # Required for GPU device access

          env:
            - name: PUID
              value: '1000'
            - name: PGID
              value: '1000'
            - name: TZ
              value: 'America/Los_Angeles'
            # Connect to Tdarr server
            - name: serverIP
              value: 'tdarr.media.svc.cluster.local'
            - name: serverPort
              value: '8266'
            - name: inContainer
              value: 'true'
            - name: ffmpegVersion
              value: '6'
            # Node name for identification in Tdarr UI
            - name: nodeName
              value: 'talos03-amd-vaapi'

          volumeMounts:
            # GPU device access
            - name: dri
              mountPath: /dev/dri
            - name: transcode-cache
              mountPath: /temp
            # TrueNAS media libraries
            - name: truenas-movies
              mountPath: /media/truenas/movies
            - name: truenas-tv
              mountPath: /media/truenas/tv
            # Synology media libraries
            - name: synology-movies
              mountPath: /media/synology/movies
            - name: synology-tv
              mountPath: /media/synology/tv

          resources:
            requests:
              cpu: "500m"
              memory: 2Gi
            limits:
              # Note: Quota limited - GPU does most work, CPU needs are low
              cpu: "900m"
              memory: 4Gi

      volumes:
        # GPU device access via hostPath
        - name: dri
          hostPath:
            path: /dev/dri
            type: Directory
        # Local transcode cache (disk-backed for larger files)
        - name: transcode-cache
          emptyDir:
            sizeLimit: 500Gi  # talos03 has 1.8TB NVMe
        # TrueNAS media libraries
        - name: truenas-movies
          persistentVolumeClaim:
            claimName: truenas-movies
        - name: truenas-tv
          persistentVolumeClaim:
            claimName: truenas-tv
        # Synology media libraries
        - name: synology-movies
          persistentVolumeClaim:
            claimName: synology-movies
        - name: synology-tv
          persistentVolumeClaim:
            claimName: synology-tv

---
# Tdarr CPU Worker Nodes
# Runs on all non-GPU nodes to provide distributed CPU transcoding
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: tdarr-node
  labels:
    app: tdarr-node
    app.kubernetes.io/name: tdarr-node
    app.kubernetes.io/part-of: arr-stack
spec:
  selector:
    matchLabels:
      app: tdarr-node
  template:
    metadata:
      labels:
        app: tdarr-node
        app.kubernetes.io/name: tdarr-node
    spec:
      # Run with NFS-compatible group (100=users on Synology, 1026=media user)
      securityContext:
        fsGroup: 100
        supplementalGroups:
          - 100    # users group (Synology)
          - 1026   # media user (Synology)
      # Don't run on GPU node (already has internal node) or control-plane
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: node-role.kubernetes.io/gpu-worker
                    operator: DoesNotExist
                  - key: node-role.kubernetes.io/control-plane
                    operator: DoesNotExist

      containers:
        - name: tdarr-node
          image: ghcr.io/haveagitgat/tdarr_node:2.58.02
          imagePullPolicy: IfNotPresent

          env:
            - name: PUID
              value: '1000'
            - name: PGID
              value: '1000'
            - name: TZ
              value: 'America/Los_Angeles'
            # Connect to Tdarr server
            - name: serverIP
              value: 'tdarr.media.svc.cluster.local'
            - name: serverPort
              value: '8266'
            - name: inContainer
              value: 'true'
            - name: ffmpegVersion
              value: '6'
            # Node name from hostname
            - name: nodeName
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName

          volumeMounts:
            - name: transcode-cache
              mountPath: /temp
            # TrueNAS media libraries
            - name: truenas-movies
              mountPath: /media/truenas/movies
            - name: truenas-tv
              mountPath: /media/truenas/tv
            # Synology media libraries
            - name: synology-movies
              mountPath: /media/synology/movies
            - name: synology-tv
              mountPath: /media/synology/tv
            # Synology archive (px200 content)
            - name: synology-archive
              mountPath: /synology-archive

          resources:
            requests:
              cpu: "2500m"
              memory: 4Gi
            limits:
              cpu: "4"
              memory: 8Gi

      volumes:
        # Local transcode cache (disk-backed for larger files)
        - name: transcode-cache
          emptyDir:
            sizeLimit: 250Gi
        # TrueNAS media libraries
        - name: truenas-movies
          persistentVolumeClaim:
            claimName: truenas-movies
        - name: truenas-tv
          persistentVolumeClaim:
            claimName: truenas-tv
        # Synology media libraries
        - name: synology-movies
          persistentVolumeClaim:
            claimName: synology-movies
        - name: synology-tv
          persistentVolumeClaim:
            claimName: synology-tv
        # Synology archive (px200 content)
        - name: synology-archive
          persistentVolumeClaim:
            claimName: synology-archive-10t

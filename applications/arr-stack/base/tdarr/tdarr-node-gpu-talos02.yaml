---
# Tdarr GPU Worker for talos02-gpu (Intel Arc - QSV/VAAPI)
# Provides hardware-accelerated transcoding via Intel Quick Sync Video
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tdarr-node-gpu-talos02
  labels:
    app: tdarr-node-gpu
    app.kubernetes.io/name: tdarr-node-gpu-talos02
    app.kubernetes.io/part-of: arr-stack
    gpu-type: intel-arc-qsv
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: tdarr-node-gpu-talos02
  template:
    metadata:
      labels:
        app: tdarr-node-gpu-talos02
        app.kubernetes.io/name: tdarr-node-gpu-talos02
        gpu-type: intel-arc-qsv
    spec:
      # Run only on talos02-gpu
      nodeSelector:
        kubernetes.io/hostname: talos02-gpu

      # Run with NFS-compatible group + video group for GPU
      securityContext:
        fsGroup: 44  # video group for GPU access
        supplementalGroups:
          - 44     # video group (GPU)
          - 100    # users group (Synology)
          - 1026   # media user (Synology)

      containers:
        - name: tdarr-node
          image: ghcr.io/haveagitgat/tdarr_node:2.58.02
          imagePullPolicy: IfNotPresent

          securityContext:
            privileged: true  # Required for GPU device access

          env:
            - name: PUID
              value: '1000'
            - name: PGID
              value: '1000'
            - name: TZ
              value: 'America/Los_Angeles'
            # Connect to Tdarr server
            - name: serverIP
              value: 'tdarr.media.svc.cluster.local'
            - name: serverPort
              value: '8266'
            - name: inContainer
              value: 'true'
            - name: ffmpegVersion
              value: '6'
            # Node name for identification in Tdarr UI
            - name: nodeName
              value: 'talos02-arc'

          volumeMounts:
            # GPU device access (Intel QSV/VAAPI)
            - name: dri
              mountPath: /dev/dri
            - name: transcode-cache
              mountPath: /temp
            # TrueNAS media libraries
            - name: truenas-movies
              mountPath: /media/truenas/movies
            # Synology media libraries
            - name: synology-movies
              mountPath: /media/synology/movies
            - name: synology-tv
              mountPath: /media/synology/tv
            # Synology archive (px200 content)
            - name: synology-archive
              mountPath: /synology-archive

          resources:
            requests:
              cpu: "500m"
              memory: 2Gi
      volumes:
        # GPU device access via hostPath
        - name: dri
          hostPath:
            path: /dev/dri
            type: Directory
        # Local transcode cache
        - name: transcode-cache
          emptyDir:
            sizeLimit: 500Gi
        # TrueNAS media libraries
        - name: truenas-movies
          persistentVolumeClaim:
            claimName: truenas-movies
        # Synology media libraries
        - name: synology-movies
          persistentVolumeClaim:
            claimName: synology-movies
        - name: synology-tv
          persistentVolumeClaim:
            claimName: synology-tv
        # Synology archive (px200 content)
        - name: synology-archive
          persistentVolumeClaim:
            claimName: synology-archive-10t

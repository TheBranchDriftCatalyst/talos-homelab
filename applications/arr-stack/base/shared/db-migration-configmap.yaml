---
# Shared ConfigMap for SQLite DB migration from NFS to local storage
# Used by media apps to avoid NFS locking issues with SQLite
apiVersion: v1
kind: ConfigMap
metadata:
  name: sqlite-db-migration
  labels:
    app.kubernetes.io/component: shared
    app.kubernetes.io/part-of: arr-stack
data:
  # For apps with DB in subdirectory (Plex, Jellyfin)
  migrate.sh: |
    #!/bin/sh
    set -e

    # Required env vars:
    # - DB_SOURCE_PATH: Path to database directory on NFS config volume
    # - DB_LOCAL_PATH: Path to local storage mount

    echo "=== SQLite DB Migration Init ==="
    echo "Source: $DB_SOURCE_PATH"
    echo "Local:  $DB_LOCAL_PATH"

    # Check if local already has databases (not first run)
    if ls "$DB_LOCAL_PATH"/*.db 1>/dev/null 2>&1; then
      echo "Local databases exist, skipping migration"
    else
      echo "First run - migrating databases to local storage"

      # Check if source databases exist on NFS
      if [ -d "$DB_SOURCE_PATH" ] && ls "$DB_SOURCE_PATH"/*.db 1>/dev/null 2>&1; then
        echo "Copying databases from NFS to local..."
        cp -av "$DB_SOURCE_PATH"/* "$DB_LOCAL_PATH/" 2>/dev/null || true
        echo "Migration complete"
      else
        echo "No existing databases found, app will create fresh ones"
        mkdir -p "$DB_LOCAL_PATH"
      fi
    fi

    # Backup original DB path and create symlink
    if [ -d "$DB_SOURCE_PATH" ] && [ ! -L "$DB_SOURCE_PATH" ]; then
      echo "Backing up original NFS database directory..."
      mv "$DB_SOURCE_PATH" "${DB_SOURCE_PATH}.nfs-backup" || true
    fi

    # Create parent directory if needed
    mkdir -p "$(dirname "$DB_SOURCE_PATH")"

    # Create symlink from NFS config location to local storage
    if [ ! -L "$DB_SOURCE_PATH" ]; then
      echo "Creating symlink: $DB_SOURCE_PATH -> $DB_LOCAL_PATH"
      ln -sf "$DB_LOCAL_PATH" "$DB_SOURCE_PATH"
    fi

    echo "=== Migration complete ==="
    ls -la "$DB_SOURCE_PATH"

  # For *arr apps with DB at /config/app.db (Sonarr, Radarr, Prowlarr, etc.)
  migrate-arr.sh: |
    #!/bin/sh
    set -e

    # Required env vars:
    # - APP_NAME: Name of the app (sonarr, radarr, prowlarr)
    # - DB_LOCAL_PATH: Path to local storage mount (e.g., /db-local)
    # - CONFIG_PATH: Path to config directory (e.g., /config)
    # Note: $${VAR} escaping prevents Flux postBuild substitution

    CONFIG_PATH="$${CONFIG_PATH:-/config}"
    DB_FILE="$${CONFIG_PATH}/$${APP_NAME}.db"

    echo "=== *arr SQLite DB Migration ==="
    echo "App: $$APP_NAME"
    echo "Config: $$CONFIG_PATH"
    echo "DB File: $$DB_FILE"
    echo "Local Storage: $$DB_LOCAL_PATH"

    # Ensure local storage dir exists
    mkdir -p "$$DB_LOCAL_PATH"

    # Helper: check if symlink exists and points to correct target
    symlink_ok() {
      [ -L "$$1" ] && [ "$$(readlink "$$1")" = "$$2" ]
    }

    # Check if symlinks are already correctly configured (idempotent check)
    if symlink_ok "$$DB_FILE" "$$DB_LOCAL_PATH/$${APP_NAME}.db"; then
      echo "Symlinks already configured correctly, nothing to do"
      echo ""
      echo "Config directory:"
      ls -la "$$CONFIG_PATH"/*.db* 2>/dev/null || echo "No DB files yet"
      echo ""
      echo "Local storage:"
      ls -la "$$DB_LOCAL_PATH/" 2>/dev/null || echo "Empty (app will create)"
      exit 0
    fi

    # Check if local already has the database (not first run)
    if [ -f "$$DB_LOCAL_PATH/$${APP_NAME}.db" ]; then
      echo "Local database exists, ensuring symlinks..."
    else
      echo "First run - checking for existing database on NFS..."

      # Check if source database exists on NFS (and is not a symlink)
      if [ -f "$$DB_FILE" ] && [ ! -L "$$DB_FILE" ]; then
        echo "Copying database from NFS to local..."
        cp -av "$${DB_FILE}" "$$DB_LOCAL_PATH/" 2>/dev/null || true
        cp -av "$${DB_FILE}-shm" "$$DB_LOCAL_PATH/" 2>/dev/null || true
        cp -av "$${DB_FILE}-wal" "$$DB_LOCAL_PATH/" 2>/dev/null || true

        # Backup original files
        echo "Backing up original NFS database files..."
        mv "$${DB_FILE}" "$${DB_FILE}.nfs-backup" 2>/dev/null || true
        mv "$${DB_FILE}-shm" "$${DB_FILE}-shm.nfs-backup" 2>/dev/null || true
        mv "$${DB_FILE}-wal" "$${DB_FILE}-wal.nfs-backup" 2>/dev/null || true
        echo "Migration complete"
      else
        echo "No existing database found, app will create fresh one on local storage"
      fi
    fi

    # Create/fix symlinks for database files (only if needed)
    for ext in "" "-shm" "-wal"; do
      src="$$DB_LOCAL_PATH/$${APP_NAME}.db$${ext}"
      dst="$$CONFIG_PATH/$${APP_NAME}.db$${ext}"

      if symlink_ok "$$dst" "$$src"; then
        echo "Symlink OK: $$dst -> $$src"
      elif [ -L "$$dst" ]; then
        echo "Fixing symlink: $$dst (was: $$(readlink "$$dst"), now: $$src)"
        rm -f "$$dst"
        ln -sf "$$src" "$$dst"
      elif [ -f "$$dst" ]; then
        echo "WARNING: $$dst is a real file, not a symlink - backing up and replacing"
        mv "$$dst" "$${dst}.replaced-$$(date +%s)" 2>/dev/null || true
        ln -sf "$$src" "$$dst"
      else
        echo "Creating symlink: $$dst -> $$src"
        ln -sf "$$src" "$$dst"
      fi
    done

    echo "=== Migration complete ==="
    echo "Config directory:"
    ls -la "$$CONFIG_PATH"/*.db* 2>/dev/null || echo "No DB files yet"
    echo ""
    echo "Local storage:"
    ls -la "$$DB_LOCAL_PATH/" 2>/dev/null || echo "Empty (app will create)"

  backup.sh: |
    #!/bin/sh
    set -e

    # Required env vars:
    # - DB_LOCAL_PATH: Path to local storage with databases
    # - BACKUP_PATH: Path to NFS backup directory

    TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    echo "=== SQLite DB Backup: $TIMESTAMP ==="

    # Create backup directory if it doesn't exist
    mkdir -p "$BACKUP_PATH"

    # Check if local databases exist
    if ! ls "$DB_LOCAL_PATH"/*.db 1>/dev/null 2>&1; then
      echo "ERROR: No local databases found to backup"
      exit 1
    fi

    # Backup all database files
    echo "Backing up databases..."
    cp -av "$DB_LOCAL_PATH"/*.db "$BACKUP_PATH/" 2>/dev/null || true
    cp -av "$DB_LOCAL_PATH"/*.db-shm "$BACKUP_PATH/" 2>/dev/null || true
    cp -av "$DB_LOCAL_PATH"/*.db-wal "$BACKUP_PATH/" 2>/dev/null || true

    # Clean old backups (keep last 5 days)
    echo "Cleaning old backups..."
    find "$BACKUP_PATH" -name "*.db-*" -mtime +5 -delete 2>/dev/null || true

    echo "=== Backup complete ==="
    ls -la "$BACKUP_PATH"
    du -sh "$BACKUP_PATH"

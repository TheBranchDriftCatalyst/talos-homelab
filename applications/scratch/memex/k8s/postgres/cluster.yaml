---
# CloudNativePG PostgreSQL Cluster for Dagster Metadata
# Docs: https://cloudnative-pg.io/documentation/current/
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: dagster-postgres
  namespace: scratch
  labels:
    app.kubernetes.io/name: dagster-postgres
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: memex
spec:
  instances: 1

  imageName: ghcr.io/cloudnative-pg/postgresql:16.4

  bootstrap:
    initdb:
      database: dagster
      owner: dagster
      secret:
        name: dagster-postgres-app
      postInitSQL:
        - |
          -- Enable required extensions for Dagster
          CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

  superuserSecret:
    name: dagster-postgres-superuser

  storage:
    size: 10Gi
    storageClass: local-path

  resources:
    requests:
      cpu: 100m
      memory: 256Mi

  monitoring:
    enablePodMonitor: true

  backup:
    barmanObjectStore:
      destinationPath: s3://memex/cnpg-backups
      endpointURL: http://minio.minio.svc.cluster.local
      s3Credentials:
        accessKeyId:
          name: dagster-s3-credentials
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: dagster-s3-credentials
          key: ACCESS_SECRET_KEY
      wal:
        compression: gzip
        maxParallel: 2
      data:
        compression: gzip
    retentionPolicy: "7d"

  postgresql:
    parameters:
      shared_buffers: "128MB"
      effective_cache_size: "256MB"
      work_mem: "16MB"
      maintenance_work_mem: "64MB"
      archive_mode: "on"
      archive_timeout: "5min"
    pg_hba:
      - host all all 10.0.0.0/8 md5
      - host all all 192.168.0.0/16 md5
---
# Application credentials secret (will be created by ExternalSecret)
apiVersion: v1
kind: Secret
metadata:
  name: dagster-postgres-app
  namespace: scratch
type: kubernetes.io/basic-auth
stringData:
  username: dagster
  password: dagster-secret-password
---
# Superuser credentials secret
apiVersion: v1
kind: Secret
metadata:
  name: dagster-postgres-superuser
  namespace: scratch
type: kubernetes.io/basic-auth
stringData:
  username: postgres
  password: postgres-super-secret

---
# Dagster User Deployments HelmRelease
# Deploys: user code servers with Congress ETL pipeline
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: dagster-user-deployments
  namespace: scratch
spec:
  interval: 30m
  dependsOn:
    - name: dagster
      namespace: scratch
  chart:
    spec:
      chart: dagster
      version: "1.9.6"
      sourceRef:
        kind: HelmRepository
        name: dagster
        namespace: scratch
      interval: 12h
  values:
    # Disable everything except user deployments
    dagsterWebserver:
      enabled: true
    dagsterDaemon:
      enabled: false
    postgresql:
      enabled: false
    runLauncher:
      enabled: false

    # User code deployments
    dagster-user-deployments:
      enabled: true
      deployments:
        - name: congress-etl
          image:
            repository: ghcr.io/thebranchdriftcatalyst/memex
            tag: latest
            pullPolicy: Always
          dagsterApiGrpcArgs:
            - "--python-file"
            - "/app/definitions.py"
          port: 3030
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
          env:
            # Congress API
            - name: CONGRESS_API_KEY
              valueFrom:
                secretKeyRef:
                  name: congress-api-credentials
                  key: API_KEY
            # Neo4j
            - name: NEO4J_URI
              valueFrom:
                secretKeyRef:
                  name: neo4j-credentials
                  key: NEO4J_URI
            - name: NEO4J_USER
              valueFrom:
                secretKeyRef:
                  name: neo4j-credentials
                  key: NEO4J_USER
            - name: NEO4J_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: neo4j-credentials
                  key: NEO4J_PASSWORD
            # S3 (MinIO)
            - name: S3_ENDPOINT_URL
              value: "http://minio.minio.svc.cluster.local"
            - name: S3_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: dagster-s3-credentials
                  key: ACCESS_KEY_ID
            - name: S3_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: dagster-s3-credentials
                  key: ACCESS_SECRET_KEY
            - name: S3_BUCKET
              value: "memex"
            # Ollama
            - name: OLLAMA_URL
              value: "http://ollama-local.catalyst-llm.svc.cluster.local:11434"

          # k8s_job_executor configuration
          # Each asset runs as a separate K8s Job
          includeConfigInLaunchedRuns:
            enabled: true

    # Instance points to external PostgreSQL
    dagsterInstance:
      postgreSQLStorage:
        host: dagster-postgres-rw.scratch.svc.cluster.local
        port: 5432
        user: dagster
        passwordSecretRef:
          name: dagster-postgres-app
          key: password
        database: dagster

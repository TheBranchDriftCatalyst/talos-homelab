---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: neo4j
  namespace: scratch
spec:
  interval: 30m
  chart:
    spec:
      chart: neo4j
      version: "5.25.1"
      sourceRef:
        kind: HelmRepository
        name: neo4j
        namespace: scratch
      interval: 12h
  values:
    # Neo4j Community Edition with APOC + GDS plugins
    neo4j:
      name: neo4j
      edition: community
      password: neo4j-password
      acceptLicenseAgreement: "yes"

      # Enable plugins for knowledge graph features
      plugins:
        - apoc
        - graph-data-science

    # Resource configuration
    resources:
      cpu: "500m"
      memory: "2Gi"

    # Storage
    volumes:
      data:
        mode: defaultStorageClass
        defaultStorageClass:
          requests:
            storage: 20Gi

    # Services
    services:
      neo4j:
        enabled: true
        spec:
          type: ClusterIP
          ports:
            http:
              enabled: true
              port: 7474
            bolt:
              enabled: true
              port: 7687

    # Configuration for APOC and vector search
    config:
      # Enable APOC procedures
      dbms.security.procedures.unrestricted: "apoc.*,gds.*"
      dbms.security.procedures.allowlist: "apoc.*,gds.*"
      # Enable vector indexes (Neo4j 5.x native)
      dbms.security.allow_csv_import_from_file_urls: "true"
      # Memory settings
      server.memory.heap.initial_size: "512m"
      server.memory.heap.max_size: "1G"
      server.memory.pagecache.size: "512m"

    # Disable clustering for single instance
    cluster:
      enabled: false

    # Security
    securityContext:
      runAsNonRoot: true
      runAsUser: 7474
      runAsGroup: 7474
      fsGroup: 7474

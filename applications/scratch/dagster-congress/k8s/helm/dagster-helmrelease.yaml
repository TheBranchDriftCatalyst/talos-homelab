---
# Dagster Infrastructure HelmRelease
# Deploys: daemon, webserver, postgresql (disabled - using CloudNativePG)
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: dagster
  namespace: scratch
spec:
  interval: 30m
  chart:
    spec:
      chart: dagster
      version: "1.9.6"
      sourceRef:
        kind: HelmRepository
        name: dagster
        namespace: scratch
      interval: 12h
  values:
    # Global settings
    global:
      serviceAccountName: dagster

    # Dagster Webserver
    dagsterWebserver:
      replicaCount: 1
      image:
        repository: dagster/dagster-celery-k8s
        tag: latest
        pullPolicy: Always
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
      service:
        type: ClusterIP
        port: 80

    # Dagster Daemon (scheduler, sensor, run coordinator)
    dagsterDaemon:
      enabled: true
      image:
        repository: dagster/dagster-celery-k8s
        tag: latest
        pullPolicy: Always
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
      runCoordinator:
        enabled: true
        type: QueuedRunCoordinator
        config:
          queuedRunCoordinator:
            maxConcurrentRuns: 5

    # Use K8sRunLauncher - creates K8s Jobs for each run
    runLauncher:
      type: K8sRunLauncher
      config:
        k8sRunLauncher:
          runK8sConfig:
            containerConfig:
              resources:
                requests:
                  cpu: 200m
                  memory: 512Mi
            podSpecConfig:
              serviceAccountName: dagster-run

    # Disable built-in PostgreSQL (using CloudNativePG)
    postgresql:
      enabled: false

    # External PostgreSQL configuration
    dagster-user-deployments:
      enabled: false  # Deployed separately

    # Instance configuration with external PostgreSQL
    dagsterInstance:
      # PostgreSQL storage
      postgreSQLStorage:
        host: dagster-postgres-rw.scratch.svc.cluster.local
        port: 5432
        user: dagster
        passwordSecretRef:
          name: dagster-postgres-app
          key: password
        database: dagster

    # Service Account
    serviceAccount:
      create: true
      name: dagster

    # RBAC for K8s Job creation
    rbac:
      create: true
---
# ServiceAccount for run jobs
apiVersion: v1
kind: ServiceAccount
metadata:
  name: dagster-run
  namespace: scratch
---
# Role for run jobs to create pods, jobs, etc.
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: dagster-run
  namespace: scratch
rules:
  - apiGroups: [""]
    resources: ["pods", "pods/log", "pods/status"]
    verbs: ["get", "list", "watch", "create", "delete"]
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["get", "list", "watch", "create", "delete"]
  - apiGroups: [""]
    resources: ["secrets", "configmaps"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: dagster-run
  namespace: scratch
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: dagster-run
subjects:
  - kind: ServiceAccount
    name: dagster-run
    namespace: scratch

---
# Home Assistant - Smart Home Automation Platform
# TODO: Add Bluetooth USB passthrough (TALOS-xxxx)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: homeassistant
  labels:
    app: homeassistant
    app.kubernetes.io/name: homeassistant
    app.kubernetes.io/part-of: home-stack
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: homeassistant
  template:
    metadata:
      labels:
        app: homeassistant
        app.kubernetes.io/name: homeassistant
      annotations:
        # Velero backup
        backup.velero.io/backup-volumes: "config"
    spec:
      # Host network for mDNS discovery and integrations
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet

      containers:
        - name: homeassistant
          image: ghcr.io/home-assistant/home-assistant:stable
          imagePullPolicy: IfNotPresent

          env:
            - name: TZ
              value: "America/Los_Angeles"

          ports:
            - name: http
              containerPort: 8123
              protocol: TCP

          volumeMounts:
            - name: config
              mountPath: /config
            # TODO: Uncomment for Bluetooth dongle support (TALOS-xxxx)
            # - name: usb
            #   mountPath: /dev/bus/usb
            # - name: dbus
            #   mountPath: /run/dbus
            #   readOnly: true

          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 120
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5

          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          resources:
            requests:
              cpu: 100m
              memory: 512Mi

      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: homeassistant-config
        # TODO: Uncomment for Bluetooth dongle support (TALOS-xxxx)
        # - name: usb
        #   hostPath:
        #     path: /dev/bus/usb
        #     type: Directory
        # - name: dbus
        #   hostPath:
        #     path: /run/dbus
        #     type: Directory

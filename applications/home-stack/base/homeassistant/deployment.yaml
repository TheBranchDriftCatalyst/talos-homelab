---
# Home Assistant - Smart Home Automation Platform
# With Bluetooth USB passthrough for BLE device support
apiVersion: apps/v1
kind: Deployment
metadata:
  name: homeassistant
  labels:
    app: homeassistant
    app.kubernetes.io/name: homeassistant
    app.kubernetes.io/part-of: home-stack
spec:
  replicas: 1
  strategy:
    type: Recreate  # Required for USB device access
  selector:
    matchLabels:
      app: homeassistant
  template:
    metadata:
      labels:
        app: homeassistant
        app.kubernetes.io/name: homeassistant
      annotations:
        # Velero backup
        backup.velero.io/backup-volumes: "config"
    spec:
      # Pin to node with Bluetooth dongle
      # Label your node: kubectl label node <node-name> bluetooth.homeassistant.io/enabled=true
      nodeSelector:
        bluetooth.homeassistant.io/enabled: "true"

      # Host network for mDNS discovery and integrations
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet

      # Required for USB/Bluetooth device access
      securityContext:
        # Run as root for device access
        runAsUser: 0
        runAsGroup: 0
        fsGroup: 0

      containers:
        - name: homeassistant
          image: ghcr.io/home-assistant/home-assistant:stable
          imagePullPolicy: IfNotPresent

          # Privileged for USB/Bluetooth access
          securityContext:
            privileged: true
            capabilities:
              add:
                - NET_ADMIN
                - NET_RAW
                - SYS_ADMIN

          env:
            - name: TZ
              value: "America/Los_Angeles"

          ports:
            - name: http
              containerPort: 8123
              protocol: TCP

          volumeMounts:
            # Config persistence
            - name: config
              mountPath: /config
            # USB devices (Bluetooth dongle)
            - name: usb
              mountPath: /dev/bus/usb
            # D-Bus for Bluetooth
            - name: dbus
              mountPath: /run/dbus
              readOnly: true
            # Bluetooth device
            - name: bluetooth
              mountPath: /dev/bluetooth
            # udev for device discovery
            - name: udev
              mountPath: /run/udev
              readOnly: true

          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 120
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5

          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          resources:
            requests:
              cpu: 100m
              memory: 512Mi

      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: homeassistant-config
        # USB bus for Bluetooth dongle
        - name: usb
          hostPath:
            path: /dev/bus/usb
            type: Directory
        # D-Bus socket for BlueZ
        - name: dbus
          hostPath:
            path: /run/dbus
            type: Directory
        # Bluetooth device nodes
        - name: bluetooth
          hostPath:
            path: /dev/bluetooth
            type: DirectoryOrCreate
        # udev for device events
        - name: udev
          hostPath:
            path: /run/udev
            type: Directory

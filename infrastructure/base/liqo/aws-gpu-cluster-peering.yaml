---
# Liqo ForeignCluster for AWS GPU Cluster
# This establishes peering between homelab (Talos) and AWS (k3s + Liqo)
#
# The cluster credentials are stored in the 'aws-gpu-cluster-credentials' secret
# which is automatically created by the orchestration script.
#
# Apply with: kubectl apply -f infrastructure/base/liqo/aws-gpu-cluster-peering.yaml
apiVersion: discovery.liqo.io/v1alpha1
kind: ForeignCluster
metadata:
  name: aws-gpu-cluster
  namespace: liqo-system
  labels:
    liqo.io/cluster-name: aws-gpu-cluster
    topology.kubernetes.io/region: aws
    topology.kubernetes.io/zone: us-west-2
spec:
  # Cluster identity (populated from secret/configmap)
  # This will be automatically filled by Liqo controller
  clusterIdentity:
    clusterID: ""  # Will be set by Liqo during peering
    clusterName: aws-gpu-cluster

  # Out-of-band peering configuration
  # We connect via Nebula mesh, not public internet
  foreignAuthURL: "https://10.42.0.1:5443"
  foreignProxyURL: ""

  # Peering type
  peeringType: OutOfBand

  # Network configuration
  # Liqo network fabric runs on top of Nebula mesh
  networkingEnabled: "Yes"

  # Resource sharing - we want to consume GPU resources from AWS
  incomingPeeringEnabled: "Yes"  # AWS shares resources TO us
  outgoingPeeringEnabled: "No"   # We don't share homelab resources to AWS
---
# Namespace offloading configuration for LLM workloads
# This tells Liqo which namespaces should schedule pods on AWS
apiVersion: offloading.liqo.io/v1alpha1
kind: NamespaceOffloading
metadata:
  name: offloading
  namespace: catalyst-llm  # The namespace where LLM workloads run
spec:
  # Offloading strategy
  namespaceMappingStrategy: EnforceSameName  # Same namespace name in remote cluster
  podOffloadingStrategy: LocalAndRemote      # Can schedule locally OR remotely

  # Cluster selector - only offload to AWS GPU cluster
  clusterSelector:
    nodeSelectorTerms:
      - matchExpressions:
          - key: liqo.io/cluster-name
            operator: In
            values:
              - aws-gpu-cluster

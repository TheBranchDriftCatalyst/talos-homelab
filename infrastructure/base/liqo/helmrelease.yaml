---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: liqo
  namespace: liqo
spec:
  interval: 1h
  url: https://helm.liqo.io/
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: liqo
  namespace: liqo
spec:
  interval: 30m
  chart:
    spec:
      chart: liqo
      version: "v1.0.1"
      sourceRef:
        kind: HelmRepository
        name: liqo
        namespace: liqo
  values:
    # Cluster identification
    discovery:
      config:
        clusterName: talos-homelab
        # Use the Nebula mesh IP for cluster communication
        clusterLabels:
          topology.kubernetes.io/region: homelab
          topology.kubernetes.io/zone: local
          liqo.io/type: homelab

    # Network configuration - required for Liqo to work
    networking:
      # Internal network CIDRs - MUST match cluster configuration
      internal: true

      # Gateway templates for inter-cluster communication
      gatewayTemplates:
        server:
          service:
            type: ClusterIP
        client:
          service:
            type: ClusterIP

    # IPAM configuration - cluster CIDRs
    ipam:
      # Pod CIDR from Talos
      podCIDR: "10.244.0.0/16"
      # Service CIDR from Talos
      serviceCIDR: "10.96.0.0/12"
      # Reserved networks (don't remap these)
      reservedSubnets:
        - "10.42.0.0/16"  # Nebula mesh network

    # Authentication settings
    auth:
      # Disable automatic mTLS rotation for simpler setup
      config:
        enableAuthentication: false

    # Controller manager
    controllerManager:
      config:
        # Resource sharing settings
        resourceSharingPercentage: 80

    # Virtual kubelet settings
    virtualKubelet:
      extra:
        # Labels to add to virtual nodes
        labels: {}
        # Annotations to add to virtual nodes
        annotations: {}

    # Metrics
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true

# ClusterMesh API Server Resources (without secrets)
# Generated via: helm template cilium cilium/cilium --version 1.16.6 --kube-version 1.31.0 ...
#
# NOTE: TLS secrets are auto-generated by Cilium and managed in-cluster.
# Do NOT commit secrets to git. The following secrets are created at runtime:
# - clustermesh-apiserver-admin-cert
# - clustermesh-apiserver-local-cert
# - clustermesh-apiserver-remote-cert
# - clustermesh-apiserver-server-cert
---
# Source: cilium/templates/clustermesh-apiserver/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: "clustermesh-apiserver"
  namespace: kube-system
---
# Source: cilium/templates/clustermesh-apiserver/clusterrole.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: clustermesh-apiserver
  labels:
    app.kubernetes.io/part-of: cilium
rules:
  - apiGroups:
      - cilium.io
    resources:
      - ciliumidentities
      - ciliumendpoints
      - ciliumnodes
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - apiextensions.k8s.io
    resources:
      - customresourcedefinitions
    verbs:
      - list
      - watch
  - apiGroups:
      - ""
    resources:
      - endpoints
      - namespaces
      - services
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - discovery.k8s.io
    resources:
      - endpointslices
    verbs:
      - get
      - list
      - watch
---
# Source: cilium/templates/clustermesh-apiserver/clusterrolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: clustermesh-apiserver
  labels:
    app.kubernetes.io/part-of: cilium
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: clustermesh-apiserver
subjects:
  - kind: ServiceAccount
    name: "clustermesh-apiserver"
    namespace: kube-system
---
# Source: cilium/templates/clustermesh-apiserver/metrics-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: clustermesh-apiserver-metrics
  namespace: kube-system
  labels:
    k8s-app: clustermesh-apiserver
    app.kubernetes.io/part-of: cilium
    app.kubernetes.io/name: clustermesh-apiserver
    app.kubernetes.io/component: metrics
spec:
  clusterIP: None
  type: ClusterIP
  ports:
    - name: apiserv-metrics
      port: 9962
      protocol: TCP
      targetPort: apiserv-metrics
    - name: kvmesh-metrics
      port: 9964
      protocol: TCP
      targetPort: kvmesh-metrics
    - name: etcd-metrics
      port: 9963
      protocol: TCP
      targetPort: etcd-metrics
  selector:
    k8s-app: clustermesh-apiserver
---
# Source: cilium/templates/clustermesh-apiserver/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: clustermesh-apiserver
  namespace: kube-system
  labels:
    k8s-app: clustermesh-apiserver
    app.kubernetes.io/part-of: cilium
    app.kubernetes.io/name: clustermesh-apiserver
spec:
  type: NodePort
  selector:
    k8s-app: clustermesh-apiserver
  ports:
    - port: 2379
      nodePort: 32379
  externalTrafficPolicy: Cluster
  internalTrafficPolicy: Cluster
---
# Source: cilium/templates/clustermesh-apiserver/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: clustermesh-apiserver
  namespace: kube-system
  labels:
    k8s-app: clustermesh-apiserver
    app.kubernetes.io/part-of: cilium
    app.kubernetes.io/name: clustermesh-apiserver
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: clustermesh-apiserver
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      annotations:
      labels:
        app.kubernetes.io/part-of: cilium
        app.kubernetes.io/name: clustermesh-apiserver
        k8s-app: clustermesh-apiserver
    spec:
      securityContext:
        fsGroup: 65532
        runAsGroup: 65532
        runAsNonRoot: true
        runAsUser: 65532
      initContainers:
        - name: etcd-init
          image: "quay.io/cilium/clustermesh-apiserver:v1.16.6@sha256:ab2070ea48a52a55d961b81b7b5fbac7d40a3f428be9b1b6b9071d47f194456a"
          imagePullPolicy: IfNotPresent
          command:
            - /usr/bin/clustermesh-apiserver
          args:
            - etcdinit
            # These need to match the equivalent arguments to etcd in the main container.
            - --etcd-cluster-name=clustermesh-apiserver
            - --etcd-initial-cluster-token=$(INITIAL_CLUSTER_TOKEN)
            - --etcd-data-dir=/var/run/etcd
          env:
            # The Cilium cluster name (specified via the `CILIUM_CLUSTER_NAME` environment variable) and the etcd cluster
            # name (specified via the `--etcd-cluster-name` argument) are very different concepts. The Cilium cluster name
            # is the name of the overall Cilium cluster, and is used to set the admin account username. The etcd cluster
            # name is a concept that's only relevant for etcd itself. The etcd cluster name must be the same for both this
            # command and the actual invocation of etcd in the main containers of this Pod, but it's otherwise not
            # relevant to Cilium.
            - name: CILIUM_CLUSTER_NAME
              valueFrom:
                configMapKeyRef:
                  name: cilium-config
                  key: cluster-name
            - name: INITIAL_CLUSTER_TOKEN
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: etcd-data-dir
              mountPath: /var/run/etcd
          terminationMessagePolicy: FallbackToLogsOnError
      containers:
        - name: etcd
          # The clustermesh-apiserver container image includes an etcd binary.
          image: "quay.io/cilium/clustermesh-apiserver:v1.16.6@sha256:ab2070ea48a52a55d961b81b7b5fbac7d40a3f428be9b1b6b9071d47f194456a"
          imagePullPolicy: IfNotPresent
          command:
            - /usr/bin/etcd
          args:
            - --data-dir=/var/run/etcd
            - --name=clustermesh-apiserver
            - --client-cert-auth
            - --trusted-ca-file=/var/lib/etcd-secrets/ca.crt
            - --cert-file=/var/lib/etcd-secrets/tls.crt
            - --key-file=/var/lib/etcd-secrets/tls.key
            # Surrounding the IPv4 address with brackets works in this case, since etcd
            # uses net.SplitHostPort() internally and it accepts the that format.
            - --listen-client-urls=https://127.0.0.1:2379,https://[$(HOSTNAME_IP)]:2379
            - --advertise-client-urls=https://[$(HOSTNAME_IP)]:2379
            - --initial-cluster-token=$(INITIAL_CLUSTER_TOKEN)
            - --auto-compaction-retention=1
            - --listen-metrics-urls=http://[$(HOSTNAME_IP)]:9963
            - --metrics=basic
          env:
            - name: ETCDCTL_API
              value: "3"
            - name: HOSTNAME_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            - name: INITIAL_CLUSTER_TOKEN
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
          ports:
            - name: etcd
              containerPort: 2379
              protocol: TCP
            - name: etcd-metrics
              containerPort: 9963
              protocol: TCP
          volumeMounts:
            - name: etcd-server-secrets
              mountPath: /var/lib/etcd-secrets
              readOnly: true
            - name: etcd-data-dir
              mountPath: /var/run/etcd
          terminationMessagePolicy: FallbackToLogsOnError
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
        - name: apiserver
          image: "quay.io/cilium/clustermesh-apiserver:v1.16.6@sha256:ab2070ea48a52a55d961b81b7b5fbac7d40a3f428be9b1b6b9071d47f194456a"
          imagePullPolicy: IfNotPresent
          command:
            - /usr/bin/clustermesh-apiserver
          args:
            - clustermesh
            - --cluster-name=$(CLUSTER_NAME)
            - --cluster-id=$(CLUSTER_ID)
            - --kvstore-opt=etcd.config=/var/lib/cilium/etcd-config.yaml
            - --kvstore-opt=etcd.qps=20
            - --kvstore-opt=etcd.bootstrapQps=10000
            - --max-connected-clusters=255
            - --health-port=9880
            - --enable-external-workloads=false
            - --prometheus-serve-addr=:9962
            - --controller-group-metrics=all
          env:
            - name: CLUSTER_NAME
              valueFrom:
                configMapKeyRef:
                  name: cilium-config
                  key: cluster-name
            - name: CLUSTER_ID
              valueFrom:
                configMapKeyRef:
                  name: cilium-config
                  key: cluster-id
                  optional: true
            - name: ENABLE_K8S_ENDPOINT_SLICE
              valueFrom:
                configMapKeyRef:
                  name: cilium-config
                  key: enable-k8s-endpoint-slice
                  optional: true
          readinessProbe:
            httpGet:
              path: /readyz
              port: apiserv-health
          ports:
            - name: apiserv-health
              containerPort: 9880
              protocol: TCP
            - name: apiserv-metrics
              containerPort: 9962
              protocol: TCP
          volumeMounts:
            - name: etcd-admin-client
              mountPath: /var/lib/cilium/etcd-secrets
              readOnly: true
          terminationMessagePolicy: FallbackToLogsOnError
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
        - name: kvstoremesh
          image: "quay.io/cilium/clustermesh-apiserver:v1.16.6@sha256:ab2070ea48a52a55d961b81b7b5fbac7d40a3f428be9b1b6b9071d47f194456a"
          imagePullPolicy: IfNotPresent
          command:
            - /usr/bin/clustermesh-apiserver
          args:
            - kvstoremesh
            - --cluster-name=$(CLUSTER_NAME)
            - --cluster-id=$(CLUSTER_ID)
            - --kvstore-opt=etcd.config=/var/lib/cilium/etcd-config.yaml
            - --kvstore-opt=etcd.qps=100
            - --kvstore-opt=etcd.bootstrapQps=10000
            - --kvstore-opt=etcd.maxInflight=10
            - --clustermesh-config=/var/lib/cilium/clustermesh
            - --max-connected-clusters=255
            - --health-port=9881
            - --prometheus-serve-addr=:9964
            - --controller-group-metrics=all
          readinessProbe:
            httpGet:
              path: /readyz
              port: kvmesh-health
          env:
            - name: CLUSTER_NAME
              valueFrom:
                configMapKeyRef:
                  name: cilium-config
                  key: cluster-name
            - name: CLUSTER_ID
              valueFrom:
                configMapKeyRef:
                  name: cilium-config
                  key: cluster-id
          ports:
            - name: kvmesh-health
              containerPort: 9881
              protocol: TCP
            - name: kvmesh-metrics
              containerPort: 9964
              protocol: TCP
          volumeMounts:
            - name: etcd-admin-client
              mountPath: /var/lib/cilium/etcd-secrets
              readOnly: true
            - name: kvstoremesh-secrets
              mountPath: /var/lib/cilium/clustermesh
              readOnly: true
          terminationMessagePolicy: FallbackToLogsOnError
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
      volumes:
        - name: etcd-server-secrets
          projected:
            # note: the leading zero means this number is in octal representation: do not remove it
            defaultMode: 0400
            sources:
              - secret:
                  name: clustermesh-apiserver-server-cert
                  items:
                    - key: tls.crt
                      path: tls.crt
                    - key: tls.key
                      path: tls.key
                    - key: ca.crt
                      path: ca.crt
        - name: etcd-admin-client
          projected:
            # note: the leading zero means this number is in octal representation: do not remove it
            defaultMode: 0400
            sources:
              - secret:
                  name: clustermesh-apiserver-admin-cert
                  items:
                    - key: tls.crt
                      path: tls.crt
                    - key: tls.key
                      path: tls.key
                    - key: ca.crt
                      path: ca.crt
        - name: etcd-data-dir
          emptyDir:
            medium: ""
        - name: kvstoremesh-secrets
          projected:
            # note: the leading zero means this number is in octal representation: do not remove it
            defaultMode: 0400
            sources:
              - secret:
                  name: cilium-kvstoremesh
                  optional: true
                  # note: items are not explicitly listed here, since the entries of this secret
                  # depend on the peers configured, and that would cause a restart of this pod
                  # at every addition/removal. Leaving the field empty makes each secret entry
                  # to be automatically projected into the volume as a file whose name is the key.
              - secret:
                  name: clustermesh-apiserver-remote-cert
                  optional: true
                  items:
                    - key: tls.key
                      path: common-etcd-client.key
                    - key: tls.crt
                      path: common-etcd-client.crt
                    - key: ca.crt
                      path: common-etcd-client-ca.crt
      restartPolicy: Always
      priorityClassName: system-cluster-critical
      serviceAccountName: "clustermesh-apiserver"
      terminationGracePeriodSeconds: 30
      automountServiceAccountToken: true
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - podAffinityTerm:
                labelSelector:
                  matchLabels:
                    k8s-app: clustermesh-apiserver
                topologyKey: kubernetes.io/hostname
              weight: 100
      nodeSelector:
        kubernetes.io/os: linux

# ClusterMesh Port Forwarder
# Workaround for Cilium eBPF not handling NodePort on TUN/Nebula interfaces
# This pod runs with hostNetwork and forwards traffic to the ClusterMesh API server
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: clustermesh-port-forwarder
  namespace: kube-system
  labels:
    app: clustermesh-port-forwarder
spec:
  selector:
    matchLabels:
      app: clustermesh-port-forwarder
  template:
    metadata:
      labels:
        app: clustermesh-port-forwarder
    spec:
      # Only run on nodes with nebula (control plane)
      nodeSelector:
        node-role.kubernetes.io/control-plane: ""
      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
        - name: socat
          image: alpine/socat:latest
          args:
            # Use port 32380 since Cilium blocks binding to NodePort 32379
            - "TCP-LISTEN:32380,fork,reuseaddr"
            - "TCP:clustermesh-apiserver.kube-system.svc.cluster.local:2379"
          ports:
            - containerPort: 32380
              hostPort: 32380
              protocol: TCP
          resources:
            limits:
              memory: 64Mi
              cpu: 100m
            requests:
              memory: 32Mi
              cpu: 10m
          securityContext:
            privileged: true

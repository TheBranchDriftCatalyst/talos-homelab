---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vpn-maintenance-scripts
  namespace: vpn-gateway
  labels:
    app.kubernetes.io/name: vpn-maintenance
    app.kubernetes.io/component: scripts
data:
  vpnctl: |
    #!/usr/bin/env python3
    """
    VPN Rotator CLI - Unified tool for rotation and inspection

    Usage: vpnctl <command> [options]

    Commands:
      rotate      Rotate all pods to new VPN servers (live)
      rotate-dry  Dry-run rotation (no changes)
      state       Show rotation state JSON
      metrics     Show Prometheus metrics from exporter
      secrets     List available VPN server keys
      pods        Show rotation-enabled pods
      status      Show current VPN exit for each pod
      help        Show this help message
    """

    import json
    import os
    import random
    import subprocess
    import sys
    import time
    import urllib.request
    import urllib.error
    from datetime import datetime, timezone
    from typing import Dict, List, Optional

    STATE_FILE = "/state/rotation-state.json"
    SECRETS_DIR = "/secrets"

    SERVER_COUNTRIES = {
        "se-be-1": "Belgium",
        "se-de-1": "Germany",
        "se-in-1": "India",
        "se-nl-1": "Netherlands",
        "se-ch-1": "Switzerland",
        "se-is-1": "Iceland",
        "se-se-1": "Sweden",
        "se-no-1": "Norway",
    }

    def log(msg: str, level: str = "INFO"):
        ts = datetime.now(timezone.utc).isoformat()
        print(f'{{"ts":"{ts}","level":"{level}","msg":"{msg}"}}', flush=True)

    # ============ State Management ============

    def load_state() -> Dict:
        try:
            with open(STATE_FILE, 'r') as f:
                return json.load(f)
        except (FileNotFoundError, json.JSONDecodeError):
            return {"server_counts": {}, "pod_servers": {}, "last_rotation": None}

    def save_state(state: Dict):
        try:
            with open(STATE_FILE, 'w') as f:
                json.dump(state, f, indent=2)
        except Exception as e:
            log(f"Failed to save state: {e}", "ERROR")

    # ============ Rotation Logic ============

    def get_available_servers() -> List[str]:
        servers = []
        try:
            for key in os.listdir(SECRETS_DIR):
                if key.startswith("se-") and not key.startswith("notes"):
                    servers.append(key)
        except Exception as e:
            log(f"Failed to read secrets: {e}", "ERROR")
        return sorted(servers)

    def pick_server_weighted(state: Dict, servers: List[str], exclude_current: Optional[str] = None) -> str:
        counts = state.get("server_counts", {})
        for s in servers:
            if s not in counts:
                counts[s] = 0
        candidates = [s for s in servers if s != exclude_current]
        if not candidates:
            candidates = servers
        min_count = min(counts.get(s, 0) for s in candidates)
        tied = [s for s in candidates if counts.get(s, 0) == min_count]
        return random.choice(tied)

    def discover_pods() -> List[Dict]:
        cmd = ["kubectl", "get", "pods", "-A", "-l", "vpn-gateway.io/rotation=enabled", "-o", "json"]
        try:
            result = subprocess.run(cmd, capture_output=True, text=True, check=True)
            data = json.loads(result.stdout)
        except Exception as e:
            log(f"Failed to discover pods: {e}", "ERROR")
            return []

        pods = []
        for item in data.get("items", []):
            meta = item.get("metadata", {})
            labels = meta.get("labels", {})
            if labels.get("vpn-gateway.io/rotation") == "disabled":
                continue
            pod_ip = item.get("status", {}).get("podIP")
            if not pod_ip:
                continue
            pods.append({
                "namespace": meta.get("namespace"),
                "name": meta.get("name"),
                "pod_ip": pod_ip,
                "deployment": labels.get("app.kubernetes.io/name", meta.get("name")),
            })
        return pods

    def rotate_pod(pod: Dict, new_server_key: str, dry_run: bool = False) -> bool:
        pod_ip = pod["pod_ip"]
        pod_name = f"{pod['namespace']}/{pod['name']}"

        try:
            key_file = os.path.join(SECRETS_DIR, new_server_key)
            with open(key_file, 'r') as f:
                wg_key = f.read().strip()
        except Exception as e:
            log(f"Failed to read key for {new_server_key}: {e}", "ERROR")
            return False

        country = SERVER_COUNTRIES.get(new_server_key, "Unknown")
        log(f"Rotating {pod_name} to {new_server_key} ({country})")

        if dry_run:
            log(f"DRY_RUN: Would rotate {pod_name} to {new_server_key}")
            return True

        try:
            url = f"http://{pod_ip}:8000/v1/vpn/settings"
            payload = json.dumps({
                "wireguard": {"private_key": wg_key},
                "provider": {"server_selection": {"countries": [country]}}
            }).encode()

            req = urllib.request.Request(url, data=payload, method="PUT",
                                         headers={"Content-Type": "application/json"})
            with urllib.request.urlopen(req, timeout=30) as resp:
                if resp.status == 200:
                    log(f"Successfully rotated {pod_name} to {new_server_key}")
                    return True
                else:
                    log(f"Rotation failed for {pod_name}: HTTP {resp.status}", "ERROR")
                    return False
        except urllib.error.HTTPError as e:
            body = e.read().decode() if hasattr(e, 'read') else str(e)
            log(f"Rotation failed for {pod_name}: HTTP {e.code} - {body}", "ERROR")
            return False
        except Exception as e:
            log(f"Rotation failed for {pod_name}: {e}", "ERROR")
            return False

    def cmd_rotate(dry_run: bool = False):
        mode = "DRY-RUN" if dry_run else "LIVE"
        log(f"VPN Rotation starting ({mode})")

        state = load_state()
        servers = get_available_servers()
        if not servers:
            log("No VPN servers found in secrets!", "ERROR")
            sys.exit(1)
        log(f"Available servers: {servers}")

        pods = discover_pods()
        if not pods:
            log("No pods found with vpn-gateway.io/rotation=enabled label", "WARN")
            sys.exit(0)
        log(f"Discovered {len(pods)} pods for rotation")

        results = []
        for pod in pods:
            deployment = pod.get("deployment", pod["name"])
            current = state.get("pod_servers", {}).get(deployment)
            new_server = pick_server_weighted(state, servers, exclude_current=current)
            success = rotate_pod(pod, new_server, dry_run=dry_run)
            results.append((deployment, new_server, success))

            if success and not dry_run:
                state.setdefault("server_counts", {})[new_server] = \
                    state.get("server_counts", {}).get(new_server, 0) + 1
                state.setdefault("pod_servers", {})[deployment] = new_server

        if not dry_run:
            state["last_rotation"] = datetime.now(timezone.utc).isoformat()
            save_state(state)

        success_count = sum(1 for _, _, s in results if s)
        error_count = len(results) - success_count
        log(f"Rotation complete: {success_count} success, {error_count} errors")

        if error_count > 0:
            sys.exit(1)

    # ============ Inspection Commands ============

    def cmd_state():
        try:
            with open(STATE_FILE, 'r') as f:
                state = json.load(f)
            print(json.dumps(state, indent=2))
        except FileNotFoundError:
            print("{}")

    def cmd_metrics():
        try:
            req = urllib.request.Request("http://vpn-rotator-exporter.vpn-gateway:9091/metrics")
            with urllib.request.urlopen(req, timeout=5) as resp:
                for line in resp.read().decode().split("\n"):
                    if not line.startswith("#"):
                        print(line)
        except Exception as e:
            print(f"Error fetching metrics: {e}", file=sys.stderr)
            sys.exit(1)

    def cmd_secrets():
        try:
            keys = sorted([k for k in os.listdir(SECRETS_DIR)
                           if k.startswith("se-") and not k.startswith("notes")])
            for key in keys:
                country = SERVER_COUNTRIES.get(key, "Unknown")
                print(f"{key}: {country}")
        except Exception as e:
            print(f"Error: {e}", file=sys.stderr)
            sys.exit(1)

    def cmd_pods():
        result = subprocess.run([
            "kubectl", "get", "pods", "-A",
            "-l", "vpn-gateway.io/rotation=enabled",
            "-o", "wide"
        ], capture_output=True, text=True)
        print(result.stdout)
        if result.stderr:
            print(result.stderr, file=sys.stderr)

    def cmd_status():
        try:
            result = subprocess.run([
                "kubectl", "get", "pods", "-A",
                "-l", "vpn-gateway.io/rotation=enabled",
                "-o", "json"
            ], capture_output=True, text=True, check=True)
            data = json.loads(result.stdout)
        except Exception as e:
            print(f"Failed to get pods: {e}", file=sys.stderr)
            sys.exit(1)

        print("=== Current VPN Exits ===\n")
        for item in data.get("items", []):
            meta = item.get("metadata", {})
            pod_name = meta.get("name", "unknown")
            namespace = meta.get("namespace", "unknown")
            pod_ip = item.get("status", {}).get("podIP")

            if not pod_ip:
                print(f"{namespace}/{pod_name}: No IP")
                continue

            try:
                url = f"http://{pod_ip}:8000/v1/publicip/ip"
                req = urllib.request.Request(url)
                with urllib.request.urlopen(req, timeout=5) as resp:
                    info = json.loads(resp.read().decode())
                    ip = info.get("public_ip", "?")
                    country = info.get("country", "?")
                    print(f"{namespace}/{pod_name}: {ip} ({country})")
            except Exception as e:
                print(f"{namespace}/{pod_name}: unavailable")

    def cmd_help():
        print(__doc__)

    # ============ Main ============

    def main():
        commands = {
            "rotate": lambda: cmd_rotate(dry_run=False),
            "rotate-dry": lambda: cmd_rotate(dry_run=True),
            "state": cmd_state,
            "metrics": cmd_metrics,
            "secrets": cmd_secrets,
            "pods": cmd_pods,
            "status": cmd_status,
            "help": cmd_help,
        }

        if len(sys.argv) < 2:
            cmd_help()
            sys.exit(1)

        cmd = sys.argv[1]
        if cmd not in commands:
            print(f"Unknown command: {cmd}")
            print(f"Available: {', '.join(commands.keys())}")
            sys.exit(1)

        commands[cmd]()

    if __name__ == "__main__":
        main()

# VPN Rotator Development Tiltfile
# Can be run standalone or included from parent
#
# This Tiltfile attaches to Flux-managed resources (no deployments).
# Resources must already exist in cluster via GitOps.

LABEL_VPN = '6-vpn-gateway'

# Rotation commands - create job from cronjob template with env overrides
local_resource(
    'rotate:dry-run',
    cmd='kubectl delete job vpn-rotator-dry -n vpn-gateway --ignore-not-found=true && kubectl get cronjob vpn-rotator -n vpn-gateway -o json | jq -M \'{apiVersion:"batch/v1",kind:"Job",metadata:{name:"vpn-rotator-dry",namespace:"vpn-gateway"},spec:(.spec.jobTemplate.spec | .template.spec.containers[0].env += [{"name":"DRY_RUN","value":"true"},{"name":"VPN_ROTATION_JITTER_MAX","value":"0"}])}\' | kubectl apply -f - && echo "Job created, waiting..." && kubectl wait --for=condition=complete job/vpn-rotator-dry -n vpn-gateway --timeout=120s && kubectl logs job/vpn-rotator-dry -n vpn-gateway',
    labels=[LABEL_VPN],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL
)

local_resource(
    'rotate:live',
    cmd='kubectl delete job vpn-rotator-live -n vpn-gateway --ignore-not-found=true && kubectl get cronjob vpn-rotator -n vpn-gateway -o json | jq -M \'{apiVersion:"batch/v1",kind:"Job",metadata:{name:"vpn-rotator-live",namespace:"vpn-gateway"},spec:(.spec.jobTemplate.spec | .template.spec.containers[0].env += [{"name":"VPN_ROTATION_JITTER_MAX","value":"0"}])}\' | kubectl apply -f - && echo "Job created, waiting..." && kubectl wait --for=condition=complete job/vpn-rotator-live -n vpn-gateway --timeout=180s && kubectl logs job/vpn-rotator-live -n vpn-gateway',
    labels=[LABEL_VPN],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL
)

# Inspect state and metrics via exporter pod
local_resource(
    'inspect:state',
    cmd='kubectl exec -n vpn-gateway deploy/vpn-rotator-exporter -- cat /state/rotation-state.json 2>/dev/null | jq . || echo "{}"',
    labels=[LABEL_VPN],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL
)

local_resource(
    'inspect:metrics',
    cmd='kubectl exec -n vpn-gateway deploy/vpn-rotator-exporter -- python3 -c "import urllib.request; print(urllib.request.urlopen(\'http://localhost:9091/metrics\').read().decode())" | grep -v "^#"',
    labels=[LABEL_VPN],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL
)

local_resource(
    'inspect:secrets',
    cmd='kubectl get secret protonvpn-credentials -n vpn-gateway -o jsonpath="{.data}" | jq -r "keys[]"',
    labels=[LABEL_VPN],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL
)

local_resource(
    'inspect:pods',
    cmd='''
        echo "=== Rotation-enabled pods ==="
        echo ""
        echo "vpn-gateway:"
        kubectl get pods -n vpn-gateway -l vpn-gateway.io/rotation=enabled -o wide 2>/dev/null || echo "  none"
        echo ""
        echo "media:"
        kubectl get pods -n media -l vpn-gateway.io/rotation=enabled -o wide 2>/dev/null || echo "  none"
    ''',
    labels=[LABEL_VPN],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL
)

local_resource(
    'inspect:vpn-status',
    cmd='echo "=== Current VPN Exits ===" && kubectl get pods -n vpn-gateway -l vpn-gateway.io/rotation=enabled -o jsonpath="{range .items[*]}{.metadata.name} {end}" | tr " " "\\n" | grep -v "^$" | xargs -I{} sh -c \'echo -n "{}: " && kubectl exec -n vpn-gateway {} -c gluetun -- wget -qO- http://localhost:8000/v1/publicip/ip 2>/dev/null | jq -r "\"\\(.public_ip) (\\(.country))\"" || echo "unavailable"\'',
    labels=[LABEL_VPN],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL
)

# Port forward for local metrics access
local_resource(
    'port-forward:metrics',
    serve_cmd='kubectl port-forward -n vpn-gateway svc/vpn-rotator-exporter 9091:9091',
    labels=[LABEL_VPN],
    auto_init=False
)

# Watch logs
local_resource(
    'logs:exporter',
    serve_cmd='kubectl logs -f -n vpn-gateway deploy/vpn-rotator-exporter',
    labels=[LABEL_VPN],
    auto_init=False
)

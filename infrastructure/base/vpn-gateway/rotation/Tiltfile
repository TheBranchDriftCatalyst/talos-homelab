# VPN Rotator Tiltfile
# All commands run via the vpn-maintenance pod
#
# This Tiltfile attaches to Flux-managed resources (no deployments).
# Resources must already exist in cluster via GitOps.

LABEL_VPN = '6-vpn-gateway'
MAINT_POD = 'kubectl exec -n vpn-gateway deploy/vpn-maintenance --'

# ============ Rotation Commands ============

local_resource(
    'rotate:dry-run',
    cmd=MAINT_POD + ' python3 /scripts/vpnctl rotate-dry',
    labels=[LABEL_VPN],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL
)

local_resource(
    'rotate:live',
    cmd=MAINT_POD + ' python3 /scripts/vpnctl rotate',
    labels=[LABEL_VPN],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL
)

# ============ Inspect Commands ============

local_resource(
    'vpnctl:state',
    cmd=MAINT_POD + ' python3 /scripts/vpnctl state',
    labels=[LABEL_VPN],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL
)

local_resource(
    'vpnctl:metrics',
    cmd=MAINT_POD + ' python3 /scripts/vpnctl metrics',
    labels=[LABEL_VPN],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL
)

local_resource(
    'vpnctl:secrets',
    cmd=MAINT_POD + ' python3 /scripts/vpnctl secrets',
    labels=[LABEL_VPN],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL
)

local_resource(
    'vpnctl:pods',
    cmd=MAINT_POD + ' python3 /scripts/vpnctl pods',
    labels=[LABEL_VPN],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL
)

local_resource(
    'vpnctl:status',
    cmd=MAINT_POD + ' python3 /scripts/vpnctl status',
    labels=[LABEL_VPN],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL
)

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: vpn-rotator
  namespace: vpn-gateway
  labels:
    app.kubernetes.io/name: vpn-rotator
    app.kubernetes.io/component: cronjob
spec:
  # Run every 35 minutes (script adds 0-10 min jitter = ~40 min effective)
  schedule: "*/35 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 1
      ttlSecondsAfterFinished: 3600
      template:
        metadata:
          labels:
            app.kubernetes.io/name: vpn-rotator
            app.kubernetes.io/component: job
        spec:
          serviceAccountName: vpn-rotator
          restartPolicy: OnFailure
          containers:
            - name: rotator
              image: dtzar/helm-kubectl:latest
              command:
                - /bin/sh
                - -c
                - |
                  # Install Python (Alpine)
                  apk add --quiet --no-cache python3 > /dev/null 2>&1
                  python3 /scripts/rotate.py
              env:
                - name: VPN_ROTATION_MODE
                  valueFrom:
                    configMapKeyRef:
                      name: vpn-rotator-config
                      key: rotation_mode
                      optional: true
                - name: VPN_ROTATION_STAGGER_DELAY
                  valueFrom:
                    configMapKeyRef:
                      name: vpn-rotator-config
                      key: stagger_delay
                      optional: true
                - name: VPN_ROTATION_JITTER_MAX
                  valueFrom:
                    configMapKeyRef:
                      name: vpn-rotator-config
                      key: jitter_max
                      optional: true
                - name: PUSHGATEWAY_URL
                  value: "http://pushgateway.monitoring:9091/metrics/job/vpn-rotator"
                - name: DRY_RUN
                  valueFrom:
                    configMapKeyRef:
                      name: vpn-rotator-config
                      key: dry_run
                      optional: true
              volumeMounts:
                - name: script
                  mountPath: /scripts
                  readOnly: true
                - name: secrets
                  mountPath: /secrets
                  readOnly: true
                - name: state
                  mountPath: /state
              resources:
                requests:
                  cpu: 50m
                  memory: 64Mi
          volumes:
            - name: script
              configMap:
                name: vpn-rotator-script
                defaultMode: 0755
            - name: secrets
              secret:
                secretName: protonvpn-credentials
            - name: state
              persistentVolumeClaim:
                claimName: vpn-rotator-state
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vpn-rotator-state
  namespace: vpn-gateway
  labels:
    app.kubernetes.io/name: vpn-rotator
    app.kubernetes.io/component: state
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Mi
  storageClassName: local-path

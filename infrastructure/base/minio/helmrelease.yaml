---
# MinIO - S3-compatible object storage
# Provides S3 backend for: Mimir, Tempo, Loki (optional)
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: minio
  namespace: minio
spec:
  interval: 1h
  url: https://charts.min.io/
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: minio
  namespace: minio
spec:
  interval: 30m
  chart:
    spec:
      chart: minio
      version: '5.2.0'
      sourceRef:
        kind: HelmRepository
        name: minio
        namespace: minio
      interval: 12h
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    # Deployment mode - standalone for homelab
    mode: standalone

    # Root credentials (change in production!)
    rootUser: minio
    rootPassword: minio123

    # Persistence using NFS appdata storage
    persistence:
      enabled: true
      storageClass: fatboy-nfs-appdata
      size: 100Gi
      accessMode: ReadWriteOnce

    # Resource limits for homelab
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

    # Console (Web UI) configuration
    consoleIngress:
      enabled: false # We'll use Traefik IngressRoute

    # API ingress
    ingress:
      enabled: false # We'll use Traefik IngressRoute

    # Service configuration
    service:
      type: ClusterIP
      port: 9000

    consoleService:
      type: ClusterIP
      port: 9001

    # Create default buckets on startup
    buckets:
      - name: mimir
        policy: none
        purge: false
      - name: tempo
        policy: none
        purge: false
      - name: loki
        policy: none
        purge: false

    # Prometheus metrics
    metrics:
      serviceMonitor:
        enabled: true
        additionalLabels:
          release: mimir  # Match Mimir's Prometheus selector

    # Environment variables for MinIO Console metrics dashboard
    environment:
      MINIO_PROMETHEUS_URL: http://mimir-nginx.monitoring.svc:80/prometheus
      MINIO_PROMETHEUS_JOB_ID: minio

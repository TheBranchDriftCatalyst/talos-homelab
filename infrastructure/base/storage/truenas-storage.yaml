---
# TrueNAS NFS Storage Configuration
# Static PVs and PVCs for media libraries and downloads
#
# Variables substituted via Flux postBuild from cluster-settings ConfigMap:
#   ${TRUENAS_IP} - TrueNAS server IP
#   ${TRUENAS_POOL} - Base pool path (e.g., /mnt/tank)

# ============================================================================
# YAML Anchors - DRY configuration
# ============================================================================
x-nfs-mount-options: &nfs-mount-options
  - hard
  - nfsvers=4.1
  - noatime
  - nodiratime
  - rsize=1048576
  - wsize=1048576

x-pv-defaults: &pv-defaults
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: truenas-nfs
  mountOptions: *nfs-mount-options

x-pvc-defaults: &pvc-defaults
  accessModes:
    - ReadWriteMany
  storageClassName: truenas-nfs

# ============================================================================
# Storage Class
# ============================================================================
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: truenas-nfs
  annotations:
    storageclass.kubernetes.io/is-default-class: "false"
provisioner: kubernetes.io/no-provisioner
reclaimPolicy: Retain
volumeBindingMode: Immediate

---
# ============================================================================
# PERSISTENT VOLUMES - Media Library
# ============================================================================
apiVersion: v1
kind: PersistentVolume
metadata:
  name: truenas-media-movies
  labels: { type: truenas-nfs, media-type: movies }
spec:
  <<: *pv-defaults
  capacity: { storage: 10Ti }
  nfs: { server: "${TRUENAS_IP}", path: "${TRUENAS_POOL}/media/movies" }

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: truenas-media-tv
  labels: { type: truenas-nfs, media-type: tv }
spec:
  <<: *pv-defaults
  capacity: { storage: 10Ti }
  nfs: { server: "${TRUENAS_IP}", path: "${TRUENAS_POOL}/media/tv" }

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: truenas-media-music
  labels: { type: truenas-nfs, media-type: music }
spec:
  <<: *pv-defaults
  capacity: { storage: 2Ti }
  nfs: { server: "${TRUENAS_IP}", path: "${TRUENAS_POOL}/media/music" }

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: truenas-media-books
  labels: { type: truenas-nfs, media-type: books }
spec:
  <<: *pv-defaults
  capacity: { storage: 500Gi }
  nfs: { server: "${TRUENAS_IP}", path: "${TRUENAS_POOL}/media/books" }

---
# ============================================================================
# PERSISTENT VOLUMES - Downloads
# ============================================================================
apiVersion: v1
kind: PersistentVolume
metadata:
  name: truenas-downloads-complete
  labels: { type: truenas-nfs, download-type: complete }
spec:
  <<: *pv-defaults
  capacity: { storage: 1Ti }
  nfs: { server: "${TRUENAS_IP}", path: "${TRUENAS_POOL}/downloads/complete" }

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: truenas-downloads-incomplete
  labels: { type: truenas-nfs, download-type: incomplete }
spec:
  <<: *pv-defaults
  capacity: { storage: 500Gi }
  nfs: { server: "${TRUENAS_IP}", path: "${TRUENAS_POOL}/downloads/incomplete" }

---
# ============================================================================
# PERSISTENT VOLUME CLAIMS - media-prod namespace
# ============================================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: truenas-movies
  namespace: media-prod
  labels: { app.kubernetes.io/component: media-storage }
spec:
  <<: *pvc-defaults
  volumeName: truenas-media-movies
  # resources: { requests: { storage: 10Ti } }

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: truenas-tv
  namespace: media-prod
  labels: { app.kubernetes.io/component: media-storage }
spec:
  <<: *pvc-defaults
  volumeName: truenas-media-tv
  # resources: { requests: { storage: 10Ti } }

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: truenas-music
  namespace: media-prod
  labels: { app.kubernetes.io/component: media-storage }
spec:
  <<: *pvc-defaults
  volumeName: truenas-media-music
  # resources: { requests: { storage: 2Ti } }

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: truenas-books
  namespace: media-prod
  labels: { app.kubernetes.io/component: media-storage }
spec:
  <<: *pvc-defaults
  volumeName: truenas-media-books
  # resources: { requests: { storage: 500Gi } }

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: truenas-downloads-complete
  namespace: media-prod
  labels: { app.kubernetes.io/component: download-storage }
spec:
  <<: *pvc-defaults
  volumeName: truenas-downloads-complete
  resources: { requests: { storage: 1Ti } }

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: truenas-downloads-incomplete
  namespace: media-prod
  labels: { app.kubernetes.io/component: download-storage }
spec:
  <<: *pvc-defaults
  volumeName: truenas-downloads-incomplete
  resources: { requests: { storage: 1Ti } }

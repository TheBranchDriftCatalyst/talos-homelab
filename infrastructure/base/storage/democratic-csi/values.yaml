# Democratic-CSI - Synology iSCSI Configuration
# Docs: https://democratic-csi.github.io/democratic-csi/
# Talos-specific config: https://github.com/siderolabs/talos/discussions/11080

csiDriver:
  name: "org.democratic-csi.iscsi"

# Talos Linux requires special node configuration
# Refs: https://github.com/siderolabs/talos/discussions/11080
node:
  hostPID: true
  driver:
    extraEnv:
      - name: ISCSIADM_HOST_STRATEGY
        value: nsenter
      - name: ISCSIADM_HOST_PATH
        value: /usr/local/sbin/iscsiadm
    # Talos puts iscsi config at /etc/iscsi (not /usr/local/etc/iscsi)
    iscsiDirHostPath: /etc/iscsi
    iscsiDirHostPathType: Directory

storageClasses:
  - name: synology-iscsi
    defaultClass: false
    reclaimPolicy: Delete
    volumeBindingMode: Immediate
    allowVolumeExpansion: true
    parameters:
      fsType: ext4
    mountOptions: []
    secrets:
      provisioner-secret:
      controller-publish-secret:
      node-stage-secret:
      node-publish-secret:
      controller-expand-secret:

driver:
  config:
    driver: synology-iscsi

    httpConnection:
      protocol: https
      host: 192.168.1.36
      port: 5001
      # TODO: TALOS-rpyc - Move to ESO and rotate
      username: catalyst
      password: "xPLY1_k."
      allowInsecure: true  # Self-signed cert

    synology:
      # Volume where LUNs will be created
      volume: /volume1

    iscsi:
      # Target settings
      targetPortal: "192.168.1.36:3260"
      targetPortals: []
      interface: ""

      # IQN base - CSI will append unique identifiers
      # IMPORTANT: Field must be 'baseiqn' (lowercase), not 'iqnBaseName'
      # Synology IQN format: iqn.2000-01.com.synology:<target-name>
      baseiqn: "iqn.2000-01.com.synology:csi."

      # Naming - synology-iscsi only supports namePrefix/nameSuffix, not nameTemplate
      # Uses PVC UUID (pvc-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx) for uniqueness
      # Full IQN limit is 223 bytes, plan accordingly
      namePrefix: "k8s-"
      nameSuffix: ""

      # LUN settings
      lunTemplate:
        type: "BLUN"
      lunSnapshotTemplate:
        type: "BLUN"
        is_locked: true

      # Target settings - Synology creates one target per LUN
      targetTemplate:
        type: "multiple"
        auth_type: 0
        max_sessions: 0

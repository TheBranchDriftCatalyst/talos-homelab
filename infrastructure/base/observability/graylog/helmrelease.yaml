---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: kongz
  namespace: observability
spec:
  interval: 24h
  url: https://charts.kong-z.com
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: graylog
  namespace: observability
spec:
  interval: 30m
  chart:
    spec:
      chart: graylog
      version: 3.0.8
      sourceRef:
        kind: HelmRepository
        name: kongz
        namespace: observability
      interval: 12h
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    tags:
      # We already have MongoDB and OpenSearch deployed separately
      install-opensearch: false
      install-mongodb: false

    # Disable MongoDB Community Operator (we use standalone MongoDB)
    mongodb:
      community:
        install: false

    # Disable OpenSearch subchart (we use existing OpenSearch)
    opensearch:
      enabled: false

    graylog:
      replicas: 1

      # Target worker node for observability workloads
      nodeSelector:
        node-role.kubernetes.io/worker: ''

      # Enable Prometheus metrics exporter
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
          additionalLabels:
            release: kube-prometheus-stack
          scrapeTimeout: 10s
          interval: 30s

      persistence:
        enabled: true
        size: 20Gi
        storageClass: local-path

      # External URI for web interface (no trailing slash - chart adds it)
      externalUri: http://graylog.talos00

      # Root user configuration
      rootUsername: admin
      # Password must be >= 16 chars (used for both login and password_secret)
      rootPassword: adminadminadmin16
      rootTimezone: America/Los_Angeles

      # Connect to existing OpenSearch
      opensearch:
        hosts: http://opensearch-cluster-master:9200

      # Connect to existing MongoDB
      mongodb:
        uri: mongodb://mongodb:27017/graylog

      # Note: GELF TCP port 12201 is exposed by default on graylog-web service
      # No need for additional input configuration

      # Resource limits - constrained by cluster capacity
      # Note: P95 was ~5.4Gi but cluster only has ~15.4Gi total
      # Keeping original memory to fit, but increased CPU for spikes
      resources:
        requests:
          cpu: 400m
          memory: 2Gi
        limits:
          cpu: 2000m
          memory: 4Gi

      # JVM heap settings (must be less than memory limit)
      # heapSize overrides chart default of 16g - set to empty to use javaOpts only
      heapSize: ""
      # Set to ~62% of memory limit (2.5GB out of 4GB) to leave room for:
      # - Metaspace (~200MB), thread stacks (~100MB), GC overhead (~500MB)
      # - Native memory, direct buffers (~700MB buffer)
      javaOpts: >-
        -Dlog4j2.formatMsgNoLookups=true
        -Djdk.tls.acknowledgeCloseNotify=true
        -XX:+UnlockExperimentalVMOptions
        -XX:-OmitStackTraceInFastThrow
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=200
        -XX:+UseStringDeduplication
        -server
        -Xms2560m -Xmx2560m

      # Provisioner to auto-create GELF TCP input on startup
      # Note: Using graylog-web service (has ClusterIP) instead of graylog (headless)
      provisioner:
        enabled: true
        script: |
          #!/bin/bash
          set -e

          GRAYLOG_BASE=http://graylog-web:9000
          MAX_ATTEMPTS=60
          ATTEMPT=0

          echo "Waiting for Graylog to be ready at $GRAYLOG_BASE..."
          until curl -sf -u "admin:adminadminadmin16" "$GRAYLOG_BASE/api/system/lbstatus" | grep -q "ALIVE"; do
            ATTEMPT=$((ATTEMPT + 1))
            if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
              echo "Timeout waiting for Graylog"
              exit 1
            fi
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Graylog not ready, waiting..."
            sleep 5
          done

          echo "Graylog is ready. Checking for existing GELF TCP input..."

          # Check if GELF TCP input already exists
          EXISTING=$(curl -sf -u "admin:adminadminadmin16" "$GRAYLOG_BASE/api/system/inputs" \
            -H "Accept: application/json" | grep -c "GELF TCP" || true)

          if [ "$EXISTING" -eq "0" ]; then
            echo "Creating GELF TCP input on port 12201..."
            curl -sf -u "admin:adminadminadmin16" \
              -H "Content-Type: application/json" \
              -H "X-Requested-By: provisioner" \
              -X POST "$GRAYLOG_BASE/api/system/inputs" \
              -d '{
                "title": "GELF TCP",
                "type": "org.graylog2.inputs.gelf.tcp.GELFTCPInput",
                "configuration": {
                  "bind_address": "0.0.0.0",
                  "port": 12201,
                  "recv_buffer_size": 1048576,
                  "number_worker_threads": 4,
                  "override_source": null,
                  "decompress_size_limit": 8388608
                },
                "global": true
              }'
            echo ""
            echo "GELF TCP input created successfully!"
          else
            echo "GELF TCP input already exists, skipping creation."
          fi

          echo "Provisioning complete!"

      # Web service configuration
      service:
        type: ClusterIP
        port: 9000

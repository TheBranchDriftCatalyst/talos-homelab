---
apiVersion: v1
kind: Secret
metadata:
  name: graylog-secret
  namespace: observability
type: Opaque
stringData:
  # TODO: Roll and move to 1Password - Generated with: pwgen -N 1 -s 96
  password-secret: 'changeme_generate_a_96_char_secret_here_for_production_use_pwgen'
  # TODO: Roll and move to 1Password - Admin password: SHA2 hash of "admin"
  root-password-sha2: '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918'
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: graylog
  namespace: observability
  labels:
    app: graylog
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: graylog
  template:
    metadata:
      labels:
        app: graylog
    spec:
      securityContext:
        fsGroup: 1100
        runAsUser: 1100
        runAsGroup: 1100
      initContainers:
        - name: create-config
          image: busybox:latest
          command: ['sh', '-c']
          args:
            - |
              cat > /config/graylog.conf <<EOF
              is_leader = true
              node_id_file = /usr/share/graylog/data/config/node-id
              password_secret = changeme_generate_a_96_char_secret_here_for_production_use_pwgen  # TODO: Roll and move to 1Password
              root_username = admin
              root_password_sha2 = 8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918  # TODO: Roll and move to 1Password
              root_timezone = America/Los_Angeles
              bin_dir = /usr/share/graylog/bin
              data_dir = /usr/share/graylog/data
              plugin_dir = /usr/share/graylog/plugin
              http_bind_address = 0.0.0.0:9000
              http_external_uri = http://graylog.talos00/
              http_publish_uri = http://graylog.talos00/
              elasticsearch_hosts = http://opensearch-cluster-master:9200
              mongodb_uri = mongodb://mongodb:27017/graylog
              allow_leading_wildcard_searches = true
              allow_highlighting = true
              EOF
              chmod 644 /config/graylog.conf
          volumeMounts:
            - name: config
              mountPath: /config
      containers:
        - name: graylog
          image: graylog/graylog:7.0
          env:
            - name: GRAYLOG_IS_LEADER
              value: 'true'
            - name: GRAYLOG_NODE_ID_FILE
              value: '/usr/share/graylog/data/config/node-id'
            - name: GRAYLOG_PASSWORD_SECRET
              valueFrom:
                secretKeyRef:
                  name: graylog-secret
                  key: password-secret
            - name: GRAYLOG_ROOT_USERNAME
              value: 'admin'
            - name: GRAYLOG_ROOT_PASSWORD_SHA2
              valueFrom:
                secretKeyRef:
                  name: graylog-secret
                  key: root-password-sha2
            - name: GRAYLOG_ROOT_TIMEZONE
              value: 'America/Los_Angeles'
            - name: GRAYLOG_ELASTICSEARCH_HOSTS
              value: 'http://opensearch-cluster-master:9200'
            - name: GRAYLOG_MONGODB_URI
              value: 'mongodb://mongodb:27017/graylog'
            - name: GRAYLOG_HTTP_BIND_ADDRESS
              value: '0.0.0.0:9000'
            - name: GRAYLOG_HTTP_EXTERNAL_URI
              value: 'http://graylog.talos00/'
            - name: GRAYLOG_HTTP_PUBLISH_URI
              value: 'http://graylog.talos00/'
          ports:
            - name: http
              containerPort: 9000
              protocol: TCP
            - name: gelf-tcp
              containerPort: 12201
              protocol: TCP
            - name: gelf-udp
              containerPort: 12201
              protocol: UDP
          volumeMounts:
            - name: data
              mountPath: /usr/share/graylog/data
            - name: config
              mountPath: /usr/share/graylog/data/config
          livenessProbe:
            httpGet:
              path: /api/system/lbstatus
              port: http
            initialDelaySeconds: 120
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /api/system/lbstatus
              port: http
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          resources:
            requests:
              cpu: 50m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1536Mi
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: graylog-data
        - name: config
          emptyDir: {}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: graylog-data
  namespace: observability
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: local-path
  resources:
    requests:
      storage: 20Gi
---
apiVersion: v1
kind: Service
metadata:
  name: graylog
  namespace: observability
  labels:
    app: graylog
spec:
  type: ClusterIP
  ports:
    - port: 9000
      targetPort: http
      protocol: TCP
      name: http
    - port: 12201
      targetPort: gelf-tcp
      protocol: TCP
      name: gelf-tcp
    - port: 12201
      targetPort: gelf-udp
      protocol: UDP
      name: gelf-udp
  selector:
    app: graylog

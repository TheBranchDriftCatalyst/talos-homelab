---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: fluent
  namespace: observability
spec:
  interval: 24h
  url: https://fluent.github.io/helm-charts
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: fluent-bit
  namespace: observability
spec:
  interval: 30m
  chart:
    spec:
      chart: fluent-bit
      version: 0.48.x
      sourceRef:
        kind: HelmRepository
        name: fluent
        namespace: observability
      interval: 12h
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    # DaemonSet ensures pod runs on every node to collect logs
    kind: DaemonSet

    serviceAccount:
      create: true

    rbac:
      create: true

    podSecurityPolicy:
      create: false

    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 256Mi

    # Configuration for Fluent Bit
    config:
      service: |
        [SERVICE]
            Daemon Off
            Flush 1
            Log_Level info
            Parsers_File parsers.conf
            Parsers_File custom_parsers.conf
            HTTP_Server On
            HTTP_Listen 0.0.0.0
            HTTP_Port 2020
            Health_Check On

      inputs: |
        [INPUT]
            Name tail
            Path /var/log/containers/*.log
            multiline.parser docker, cri
            Parser docker_no_time
            Tag kube.*
            Mem_Buf_Limit 5MB
            Skip_Long_Lines On

      filters: |
        [FILTER]
            Name kubernetes
            Match kube.*
            Kube_URL https://kubernetes.default.svc:443
            Kube_CA_File /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
            Kube_Token_File /var/run/secrets/kubernetes.io/serviceaccount/token
            Kube_Tag_Prefix kube.var.log.containers.
            Merge_Log On
            Keep_Log Off
            K8S-Logging.Parser On
            K8S-Logging.Exclude On

        # Add cluster identifier as GELF custom field
        [FILTER]
            Name modify
            Match *
            Add _cluster talos-homelab

        # Add Kubernetes metadata as GELF custom fields (using modify filter with Copy)
        [FILTER]
            Name modify
            Match *
            Copy kubernetes.namespace_name _namespace
            Condition Key_Exists kubernetes.namespace_name

        [FILTER]
            Name modify
            Match *
            Copy kubernetes.pod_name _pod
            Condition Key_Exists kubernetes.pod_name

        [FILTER]
            Name modify
            Match *
            Copy kubernetes.container_name _container
            Condition Key_Exists kubernetes.container_name

        [FILTER]
            Name modify
            Match *
            Copy kubernetes.host _node
            Condition Key_Exists kubernetes.host

        # Add app label if exists
        [FILTER]
            Name modify
            Match *
            Copy kubernetes.labels.app _app
            Condition Key_Exists kubernetes.labels.app

        # Ensure log field exists (for GELF short_message)
        [FILTER]
            Name modify
            Match *
            Copy message log
            Condition Key_Does_Not_Exist log

        [FILTER]
            Name modify
            Match *
            Copy stream log
            Condition Key_Does_Not_Exist log

        [FILTER]
            Name modify
            Match *
            Set log no_message
            Condition Key_Does_Not_Exist log

        # Set host field for GELF (use pod name)
        [FILTER]
            Name modify
            Match *
            Copy kubernetes.pod_name host
            Condition Key_Does_Not_Exist host

        [FILTER]
            Name modify
            Match *
            Set host talos00
            Condition Key_Does_Not_Exist host

        # Parse log level from message and map to syslog severity
        [FILTER]
            Name lua
            Match *
            script /fluent-bit/scripts/gelf-enrich.lua
            call enrich_gelf

      outputs: |
        [OUTPUT]
            Name gelf
            Match *
            Host graylog-web.observability.svc.cluster.local
            Port 12201
            Mode tcp
            Gelf_Short_Message_Key log
            Gelf_Host_Key host
            # Let GELF plugin handle timestamp conversion automatically

      customParsers: |
        [PARSER]
            Name docker_no_time
            Format json
            Time_Keep Off
            Time_Key time
            Time_Format %Y-%m-%dT%H:%M:%S.%L

    # Lua scripts for log enrichment
    luaScripts:
      gelf-enrich.lua: |
        function enrich_gelf(tag, timestamp, record)
            -- Extract log level from message
            local message = record["log"] or ""

            -- Map log levels to syslog severity
            local level_map = {
                ["FATAL"] = 2,    -- Critical
                ["PANIC"] = 2,    -- Critical
                ["ERROR"] = 3,    -- Error
                ["WARN"] = 4,     -- Warning
                ["WARNING"] = 4,  -- Warning
                ["INFO"] = 6,     -- Informational
                ["DEBUG"] = 7,    -- Debug
                ["TRACE"] = 7     -- Debug
            }

            -- Default to informational
            record["level"] = 6
            record["_log_level"] = "INFO"

            -- Search for log level in message (case-insensitive)
            for level_name, level_num in pairs(level_map) do
                if string.match(message:upper(), level_name) then
                    record["level"] = level_num
                    record["_log_level"] = level_name
                    break
                end
            end

            -- Extract app from Kubernetes labels if not already set
            if not record["_app"] and record["kubernetes"] and record["kubernetes"]["labels"] then
                if record["kubernetes"]["labels"]["app"] then
                    record["_app"] = record["kubernetes"]["labels"]["app"]
                elseif record["kubernetes"]["labels"]["app.kubernetes.io/name"] then
                    record["_app"] = record["kubernetes"]["labels"]["app.kubernetes.io/name"]
                end
            end

            -- Return: code (2 = success), unmodified timestamp, modified record
            -- Let the GELF output plugin handle timestamp conversion
            return 2, timestamp, record
        end

    # Tolerations to ensure Fluent Bit runs on all nodes
    tolerations:
      - effect: NoSchedule
        operator: Exists
      - effect: NoExecute
        operator: Exists

    # Volume mounts for container logs
    volumeMounts:
      - name: varlog
        mountPath: /var/log
      - name: varlibdockercontainers
        mountPath: /var/lib/docker/containers
        readOnly: true
      - name: etcmachineid
        mountPath: /etc/machine-id
        readOnly: true

    daemonSetVolumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
      - name: etcmachineid
        hostPath:
          path: /etc/machine-id
          type: File

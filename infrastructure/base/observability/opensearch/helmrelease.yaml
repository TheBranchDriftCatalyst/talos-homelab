---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: opensearch
  namespace: observability
spec:
  interval: 24h
  url: https://opensearch-project.github.io/helm-charts/
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: opensearch
  namespace: observability
spec:
  interval: 30m
  chart:
    spec:
      chart: opensearch
      version: 3.3.2
      sourceRef:
        kind: HelmRepository
        name: opensearch
        namespace: observability
      interval: 12h
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    clusterName: opensearch-cluster
    nodeGroup: master
    replicas: 1

    image:
      repository: opensearchproject/opensearch
      tag: '2.15.0'

    # JVM heap sized for memory limit (1g out of 2Gi)
    opensearchJavaOpts: '-Xms1g -Xmx1g'

    # Sized for P95 usage (~36m CPU, ~1.2Gi memory)
    resources:
      limits:
        cpu: 1000m
        memory: 2Gi
      requests:
        cpu: 50m
        memory: 1450Mi

    persistence:
      enabled: true
      size: 30Gi
      storageClass: local-path

    securityConfig:
      enabled: false

    sysctlInit:
      enabled: true

    # Target worker node for observability workloads
    nodeSelector:
      node-role.kubernetes.io/worker: ''

    config:
      opensearch.yml: |
        cluster.name: opensearch-cluster
        network.host: 0.0.0.0
        plugins:
          security:
            disabled: true

    extraEnvs:
      - name: OPENSEARCH_INITIAL_ADMIN_PASSWORD
        value: 'Admin123!@#'
      - name: DISABLE_SECURITY_PLUGIN
        value: 'true'

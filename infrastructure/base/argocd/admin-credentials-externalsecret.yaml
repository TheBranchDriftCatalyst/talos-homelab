# ArgoCD Admin Credentials from 1Password
# Pulls from the "default-service-admin" entry in 1Password
# Required fields in 1Password:
#   - password: plaintext password
#
# Note: This creates the complete argocd-secret. ArgoCD Helm chart has createSecret: false
# The password is hashed using bcrypt within the template.
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: argocd-admin-credentials
  namespace: argocd
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: onepassword
    kind: ClusterSecretStore
  target:
    name: argocd-secret
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      data:
        # ArgoCD server secret key for signing (required)
        # Using password-derived value for simplicity in homelab
        server.secretkey: '{{ .password | sha256sum }}'
        # Admin password - bcrypt hash generated from plaintext
        # Note: ESO doesn't have bcrypt, so we pull pre-hashed from 1Password
        admin.password: '{{ .password_bcrypt }}'
        admin.passwordMtime: '{{ now | date "2006-01-02T15:04:05Z" }}'
  data:
    - secretKey: password
      remoteRef:
        key: default-service-admin
        property: password
    - secretKey: password_bcrypt
      remoteRef:
        key: default-service-admin
        property: password-bcrypt

# ArgoCD Admin Credentials from 1Password
# Pulls from the "default-service-admin" entry in 1Password
# Required fields in 1Password:
#   - username: admin username
#   - password: plaintext password (for reference)
#   - password-bcrypt: bcrypt hash of password (generate with: htpasswd -nbBC 10 "" "PASSWORD" | tr -d ':\n')
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: argocd-admin-credentials
  namespace: argocd
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: onepassword
    kind: ClusterSecretStore
  target:
    name: argocd-secret
    creationPolicy: Merge  # Merge with existing argocd-secret created by Helm
    template:
      type: Opaque
      data:
        # ArgoCD expects bcrypt hash for admin.password
        admin.password: "{{ .password_bcrypt }}"
        admin.passwordMtime: "{{ now | date \"2006-01-02T15:04:05Z\" }}"
  data:
    - secretKey: password_bcrypt
      remoteRef:
        key: default-service-admin
        property: password-bcrypt

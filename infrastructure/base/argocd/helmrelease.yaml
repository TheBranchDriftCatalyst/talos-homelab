---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: argocd
  namespace: argocd
spec:
  interval: 24h
  url: https://argoproj.github.io/argo-helm
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: argocd
  namespace: argocd
spec:
  interval: 30m
  timeout: 20m
  chart:
    spec:
      chart: argo-cd
      version: '>=7.0.0 <8.0.0' # Lock to v7.x for stability
      sourceRef:
        kind: HelmRepository
        name: argocd
        namespace: argocd
      interval: 12h

  install:
    crds: Create
    createNamespace: false
    remediation:
      retries: 3

  upgrade:
    crds: CreateReplace
    cleanupOnFail: true
    remediation:
      retries: 3

  values:
    # Global settings
    global:
      domain: argocd.talos00

    # Redis
    redis:
      enabled: true
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 128Mi

    # Argo CD Server
    server:
      replicas: 1

      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 256Mi

      # Allow insecure mode (we're behind Traefik)
      extraArgs:
        - --insecure

      # Ingress configuration
      ingress:
        enabled: false # We'll use Traefik IngressRoute

    # Repo Server
    repoServer:
      replicas: 1

      resources:
        requests:
          cpu: 10m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 256Mi

    # Application Controller
    controller:
      replicas: 1

      resources:
        requests:
          cpu: 50m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi

    # ApplicationSet Controller
    applicationSet:
      enabled: true

      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 128Mi

    # Notifications Controller
    notifications:
      enabled: true

      # Use secret created by ExternalSecret
      secret:
        create: false
        name: argocd-notifications-secret

      # Notification services configuration
      notifiers:
        service.webhook.discord: |
          url: $discord-webhook-url
          headers:
            - name: Content-Type
              value: application/json

      # Subscription for all applications - on-sync-succeeded and on-sync-failed
      subscriptions:
        - recipients:
            - discord
          triggers:
            - on-sync-succeeded
            - on-sync-failed
            - on-health-degraded

      # Notification templates - Synthwave Cyberpunk Catalyst Edition
      templates:
        template.app-sync-succeeded: |
          webhook:
            discord:
              method: POST
              body: |
                {
                  "username": "CATALYST // ArgoCD",
                  "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/argo.png",
                  "embeds": [{
                    "title": "▓▒░ SYNC COMPLETE ░▒▓",
                    "description": "```ansi\n\u001b[0;36m╔══════════════════════════════════════╗\n║  \u001b[0;32m✓ DEPLOYMENT SUCCESSFUL\u001b[0;36m             ║\n╚══════════════════════════════════════╝\u001b[0m\n```\n\n**`{{.app.metadata.name}}`** has been synchronized to the grid.",
                    "color": 65535,
                    "thumbnail": {"url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/ui/src/assets/images/argo_o.svg"},
                    "fields": [
                      {"name": "⟨ PROJECT ⟩", "value": "```{{.app.spec.project}}```", "inline": true},
                      {"name": "⟨ REVISION ⟩", "value": "```{{.app.status.sync.revision | trunc 7}}```", "inline": true},
                      {"name": "⟨ CLUSTER ⟩", "value": "```talos00```", "inline": true},
                      {"name": "⟨ NAMESPACE ⟩", "value": "```{{.app.spec.destination.namespace}}```", "inline": true},
                      {"name": "⟨ SYNC STATUS ⟩", "value": "```diff\n+ SYNCED\n```", "inline": true},
                      {"name": "⟨ HEALTH ⟩", "value": "```diff\n+ {{.app.status.health.status}}\n```", "inline": true}
                    ],
                    "footer": {"text": "⚡ CATALYST INFRASTRUCTURE // TALOS-00 GRID", "icon_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/argo.png"},
                    "timestamp": "{{.app.status.operationState.finishedAt}}"
                  }]
                }

        template.app-sync-failed: |
          webhook:
            discord:
              method: POST
              body: |
                {
                  "username": "CATALYST // ArgoCD",
                  "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/argo.png",
                  "embeds": [{
                    "title": "▓▒░ SYNC FAILURE ░▒▓",
                    "description": "```ansi\n\u001b[0;31m╔══════════════════════════════════════╗\n║  ✗ CRITICAL SYNC ERROR               ║\n╚══════════════════════════════════════╝\u001b[0m\n```\n\n**`{{.app.metadata.name}}`** failed to synchronize.\n\n**Error Output:**\n```{{.app.status.operationState.message}}```",
                    "color": 16711935,
                    "thumbnail": {"url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/ui/src/assets/images/argo_o.svg"},
                    "fields": [
                      {"name": "⟨ PROJECT ⟩", "value": "```{{.app.spec.project}}```", "inline": true},
                      {"name": "⟨ REVISION ⟩", "value": "```{{.app.status.sync.revision | trunc 7}}```", "inline": true},
                      {"name": "⟨ CLUSTER ⟩", "value": "```talos00```", "inline": true},
                      {"name": "⟨ SYNC STATUS ⟩", "value": "```diff\n- FAILED\n```", "inline": true},
                      {"name": "⟨ PHASE ⟩", "value": "```diff\n- {{.app.status.operationState.phase}}\n```", "inline": true}
                    ],
                    "footer": {"text": "⚠ CATALYST INFRASTRUCTURE // ALERT CONDITION", "icon_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/argo.png"},
                    "timestamp": "{{.app.status.operationState.finishedAt}}"
                  }]
                }

        template.app-health-degraded: |
          webhook:
            discord:
              method: POST
              body: |
                {
                  "username": "CATALYST // ArgoCD",
                  "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/argo.png",
                  "embeds": [{
                    "title": "▓▒░ HEALTH DEGRADED ░▒▓",
                    "description": "```ansi\n\u001b[0;33m╔══════════════════════════════════════╗\n║  ⚠ SYSTEM HEALTH WARNING             ║\n╚══════════════════════════════════════╝\u001b[0m\n```\n\n**`{{.app.metadata.name}}`** health status has degraded.\nInitiating diagnostic protocols...",
                    "color": 16776960,
                    "thumbnail": {"url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/ui/src/assets/images/argo_o.svg"},
                    "fields": [
                      {"name": "⟨ PROJECT ⟩", "value": "```{{.app.spec.project}}```", "inline": true},
                      {"name": "⟨ HEALTH ⟩", "value": "```fix\n~ {{.app.status.health.status}}\n```", "inline": true},
                      {"name": "⟨ CLUSTER ⟩", "value": "```talos00```", "inline": true},
                      {"name": "⟨ NAMESPACE ⟩", "value": "```{{.app.spec.destination.namespace}}```", "inline": true},
                      {"name": "⟨ SYNC STATUS ⟩", "value": "```{{.app.status.sync.status}}```", "inline": true}
                    ],
                    "footer": {"text": "⚡ CATALYST INFRASTRUCTURE // MONITORING ACTIVE", "icon_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/argo.png"},
                    "timestamp": "{{.app.status.operationState.finishedAt}}"
                  }]
                }

        template.app-deployed: |
          webhook:
            discord:
              method: POST
              body: |
                {
                  "username": "CATALYST // ArgoCD",
                  "avatar_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/argo.png",
                  "embeds": [{
                    "title": "▓▒░ NEW DEPLOYMENT ░▒▓",
                    "description": "```ansi\n\u001b[0;35m╔══════════════════════════════════════╗\n║  ◈ INITIALIZING NEW APPLICATION      ║\n╚══════════════════════════════════════╝\u001b[0m\n```\n\n**`{{.app.metadata.name}}`** has been deployed to the Catalyst grid.",
                    "color": 10181046,
                    "thumbnail": {"url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/ui/src/assets/images/argo_o.svg"},
                    "fields": [
                      {"name": "⟨ PROJECT ⟩", "value": "```{{.app.spec.project}}```", "inline": true},
                      {"name": "⟨ NAMESPACE ⟩", "value": "```{{.app.spec.destination.namespace}}```", "inline": true},
                      {"name": "⟨ SOURCE ⟩", "value": "```{{.app.spec.source.repoURL | trunc 40}}```", "inline": false}
                    ],
                    "footer": {"text": "⚡ CATALYST INFRASTRUCTURE // TALOS-00 GRID", "icon_url": "https://raw.githubusercontent.com/argoproj/argo-cd/master/docs/assets/argo.png"},
                    "timestamp": "{{.app.metadata.creationTimestamp}}"
                  }]
                }

      # Triggers
      triggers:
        trigger.on-sync-succeeded: |
          - when: app.status.operationState.phase in ['Succeeded'] and app.status.health.status == 'Healthy'
            send: [app-sync-succeeded]
        trigger.on-sync-failed: |
          - when: app.status.operationState.phase in ['Error', 'Failed']
            send: [app-sync-failed]
        trigger.on-health-degraded: |
          - when: app.status.health.status == 'Degraded'
            send: [app-health-degraded]
        trigger.on-deployed: |
          - when: app.status.operationState.phase in ['Succeeded'] and app.status.health.status == 'Healthy' and time.Now().Sub(time.Parse(app.metadata.creationTimestamp)).Minutes() < 2
            send: [app-deployed]

    # Dex (SSO) - disabled for homelab
    dex:
      enabled: false

    # Admin password managed via ExternalSecret (argocd-admin-credentials)
    # The ExternalSecret merges admin.password into the argocd-secret
    configs:
      secret:
        # Don't create default password - managed by ExternalSecret
        createSecret: false

      # Repository credentials (will be added via kubectl later)
      repositories: {}

      # Default project settings
      params:
        server.insecure: true
        application.instanceLabelKey: argocd.argoproj.io/instance

    # RBAC Configuration
    rbac:
      policy.default: role:readonly
      policy.csv: |
        p, role:org-admin, applications, *, */*, allow
        p, role:org-admin, clusters, get, *, allow
        p, role:org-admin, repositories, get, *, allow
        p, role:org-admin, repositories, create, *, allow
        p, role:org-admin, repositories, update, *, allow
        p, role:org-admin, repositories, delete, *, allow
        g, admin, role:admin

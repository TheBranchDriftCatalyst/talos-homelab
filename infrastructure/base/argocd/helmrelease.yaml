---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: argocd
  namespace: argocd
spec:
  interval: 24h
  url: https://argoproj.github.io/argo-helm
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: argocd
  namespace: argocd
spec:
  interval: 30m
  timeout: 20m
  chart:
    spec:
      chart: argo-cd
      version: '>=7.0.0 <8.0.0' # Lock to v7.x for stability
      sourceRef:
        kind: HelmRepository
        name: argocd
        namespace: argocd
      interval: 12h

  install:
    crds: Create
    createNamespace: false
    remediation:
      retries: 3

  upgrade:
    crds: CreateReplace
    cleanupOnFail: true
    remediation:
      retries: 3

  values:
    # Global settings
    global:
      domain: argocd.talos00

    # Redis
    redis:
      enabled: true
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 128Mi

    # Argo CD Server
    server:
      replicas: 1

      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 256Mi

      # Allow insecure mode (we're behind Traefik)
      extraArgs:
        - --insecure

      # Ingress configuration
      ingress:
        enabled: false # We'll use Traefik IngressRoute

    # Repo Server
    repoServer:
      replicas: 1

      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi

    # Application Controller
    controller:
      replicas: 1

      resources:
        requests:
          cpu: 250m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 1Gi

    # ApplicationSet Controller
    applicationSet:
      enabled: true

      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 128Mi

    # Notifications Controller
    notifications:
      enabled: true

      # Use secret created by ExternalSecret
      secret:
        create: false
        name: argocd-notifications-secret

      # Notification services configuration
      notifiers:
        service.webhook.discord: |
          url: $discord-webhook-url
          headers:
            - name: Content-Type
              value: application/json

      # Subscription for all applications - on-sync-succeeded and on-sync-failed
      subscriptions:
        - recipients:
            - discord
          triggers:
            - on-sync-succeeded
            - on-sync-failed
            - on-health-degraded

      # Notification templates
      templates:
        template.app-sync-succeeded: |
          webhook:
            discord:
              method: POST
              body: |
                {
                  "username": "ArgoCD",
                  "embeds": [{
                    "title": "✅ {{.app.metadata.name}} synced successfully",
                    "description": "Application **{{.app.metadata.name}}** has been synced successfully.",
                    "color": 3066993,
                    "fields": [
                      {"name": "Project", "value": "{{.app.spec.project}}", "inline": true},
                      {"name": "Revision", "value": "{{.app.status.sync.revision | trunc 7}}", "inline": true},
                      {"name": "Destination", "value": "{{.app.spec.destination.server}}", "inline": true}
                    ],
                    "timestamp": "{{.app.status.operationState.finishedAt}}"
                  }]
                }

        template.app-sync-failed: |
          webhook:
            discord:
              method: POST
              body: |
                {
                  "username": "ArgoCD",
                  "embeds": [{
                    "title": "❌ {{.app.metadata.name}} sync failed",
                    "description": "Application **{{.app.metadata.name}}** sync has failed!\n\n{{.app.status.operationState.message}}",
                    "color": 15158332,
                    "fields": [
                      {"name": "Project", "value": "{{.app.spec.project}}", "inline": true},
                      {"name": "Revision", "value": "{{.app.status.sync.revision | trunc 7}}", "inline": true}
                    ],
                    "timestamp": "{{.app.status.operationState.finishedAt}}"
                  }]
                }

        template.app-health-degraded: |
          webhook:
            discord:
              method: POST
              body: |
                {
                  "username": "ArgoCD",
                  "embeds": [{
                    "title": "⚠️ {{.app.metadata.name}} health degraded",
                    "description": "Application **{{.app.metadata.name}}** health status is **{{.app.status.health.status}}**",
                    "color": 15105570,
                    "fields": [
                      {"name": "Project", "value": "{{.app.spec.project}}", "inline": true},
                      {"name": "Health Status", "value": "{{.app.status.health.status}}", "inline": true}
                    ]
                  }]
                }

      # Triggers
      triggers:
        trigger.on-sync-succeeded: |
          - when: app.status.operationState.phase in ['Succeeded'] and app.status.health.status == 'Healthy'
            send: [app-sync-succeeded]
        trigger.on-sync-failed: |
          - when: app.status.operationState.phase in ['Error', 'Failed']
            send: [app-sync-failed]
        trigger.on-health-degraded: |
          - when: app.status.health.status == 'Degraded'
            send: [app-health-degraded]

    # Dex (SSO) - disabled for homelab
    dex:
      enabled: false

    # Default admin password (change after first login!)
    configs:
      secret:
        argocdServerAdminPassword: '$2a$10$mivhwttXM0U5eBrZGtAG8.VSRL1l9cZNAmaSaqotIzXRBRwID6gyO' # "admin"
        argocdServerAdminPasswordMtime: '2024-01-01T00:00:00Z'

      # Repository credentials (will be added via kubectl later)
      repositories: {}

      # Default project settings
      params:
        server.insecure: true
        application.instanceLabelKey: argocd.argoproj.io/instance

    # RBAC Configuration
    rbac:
      policy.default: role:readonly
      policy.csv: |
        p, role:org-admin, applications, *, */*, allow
        p, role:org-admin, clusters, get, *, allow
        p, role:org-admin, repositories, get, *, allow
        p, role:org-admin, repositories, create, *, allow
        p, role:org-admin, repositories, update, *, allow
        p, role:org-admin, repositories, delete, *, allow
        g, admin, role:admin

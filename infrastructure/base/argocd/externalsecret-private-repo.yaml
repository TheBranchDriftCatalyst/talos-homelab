---
# ExternalSecret for ArgoCD private repository credentials
# Pulls SSH key from 1Password vault 'catalyst-eso'
#
# 1Password item requirements:
#   - Vault: catalyst-eso
#   - Item name: argocd-private-repo-ssh
#   - Field: sshPrivateKey (the full SSH private key, no passphrase)
#
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: private-repo-creds
  namespace: argocd
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: onepassword
    kind: ClusterSecretStore

  target:
    name: private-repo-creds
    creationPolicy: Owner
    template:
      metadata:
        labels:
          # This label tells ArgoCD this is a repository credential
          argocd.argoproj.io/secret-type: repository
      type: Opaque
      stringData:
        type: git
        url: git@github.com:TheBranchDriftCatalyst/private.git
        sshPrivateKey: "{{ .sshPrivateKey }}"

  data:
    - secretKey: sshPrivateKey
      remoteRef:
        key: argocd-private-repo-ssh
        property: sshPrivateKey

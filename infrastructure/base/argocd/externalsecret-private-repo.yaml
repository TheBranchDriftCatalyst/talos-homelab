---
# ExternalSecret for ArgoCD private repository credentials
# Pulls SSH key from 1Password vault 'catalyst-eso'
#
# 1Password item requirements:
#   - Vault: catalyst-eso
#   - Item name: argocd-private-repo-ssh
#   - Field: sshPrivateKey (the full SSH private key)
#
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: private-repo-creds
  namespace: argocd
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: onepassword
    kind: ClusterSecretStore

  target:
    name: private-repo-creds
    creationPolicy: Owner
    template:
      metadata:
        labels:
          # This label tells ArgoCD this is a repository credential
          argocd.argoproj.io/secret-type: repository
      type: Opaque
      data:
        # Hardcoded - always git for SSH repos
        type: Z2l0  # base64 encoded "git"
        url: "{{ .url | b64enc }}"
        sshPrivateKey: "{{ .sshPrivateKey | b64enc }}"

  data:
    - secretKey: url
      remoteRef:
        key: argocd-private-repo-ssh
        property: url

    - secretKey: sshPrivateKey
      remoteRef:
        key: argocd-private-repo-ssh
        property: sshPrivateKey

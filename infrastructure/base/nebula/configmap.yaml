---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nebula-config
  namespace: nebula-system
data:
  config.yaml: |
    pki:
      ca: /etc/nebula/ca.crt
      cert: /etc/nebula/host.crt
      key: /etc/nebula/host.key

    static_host_map:
      # Lighthouse at AWS Elastic IP
      "10.42.0.1": ["52.13.210.163:4242"]

    lighthouse:
      am_lighthouse: false
      interval: 60
      hosts:
        - "10.42.0.1"

    listen:
      host: 0.0.0.0
      port: 4242

    punchy:
      punch: true
      respond: true

    tun:
      dev: nebula1
      drop_local_broadcast: false
      drop_multicast: false
      tx_queue: 500
      mtu: 1300

    logging:
      level: info
      format: text

    firewall:
      # Allow all outbound traffic
      outbound:
        - port: any
          proto: any
          host: any

      # Inbound rules
      inbound:
        # Allow all traffic from lighthouse
        - port: any
          proto: any
          group: lighthouse

        # Allow all traffic from infrastructure group
        - port: any
          proto: any
          group: infrastructure

        # Allow all traffic from kubernetes group
        - port: any
          proto: any
          group: kubernetes

        # Allow all traffic from homelab group
        - port: any
          proto: any
          group: homelab

        # Allow ICMP from anywhere in the mesh
        - port: any
          proto: icmp
          host: any

        # Allow Kubernetes API traffic
        - port: 6443
          proto: tcp
          host: any

        # Allow kubelet
        - port: 10250
          proto: tcp
          host: any

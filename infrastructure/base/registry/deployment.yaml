---
apiVersion: v1
kind: Namespace
metadata:
  name: registry
  labels:
    name: registry
    pod-security.kubernetes.io/enforce: privileged
    pod-security.kubernetes.io/audit: privileged
    pod-security.kubernetes.io/warn: privileged
    # Enable Goldilocks resource recommendations
    goldilocks.fairwinds.com/enabled: 'true'
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nexus-data
  namespace: registry
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: fatboy-nfs-appdata
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nexus-properties
  namespace: registry
data:
  nexus.properties: |
    # Nexus configuration
    nexus.scripts.allowCreation=true
    nexus.onboarding.enabled=false
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexus
  namespace: registry
  labels:
    app: nexus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nexus
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: nexus
    spec:
      securityContext:
        runAsUser: 0
        runAsGroup: 0
        fsGroup: 0
      containers:
        - name: nexus
          image: sonatype/nexus3:3.72.0
          securityContext:
            runAsUser: 0
          ports:
            - name: nexus-ui
              containerPort: 8081
              protocol: TCP
            - name: docker-hosted
              containerPort: 5000
              protocol: TCP
            - name: docker-proxy
              containerPort: 5001
              protocol: TCP
            - name: npm
              containerPort: 8082
              protocol: TCP
          volumeMounts:
            - name: nexus-data
              mountPath: /nexus-data
          env:
            - name: INSTALL4J_ADD_VM_PARAMS
              value: >-
                -Xms1024m -Xmx2048m
                -XX:MaxDirectMemorySize=2048m
                -Djava.util.prefs.userRoot=/nexus-data/javaprefs
          resources:
            requests:
              cpu: 500m
              memory: 2Gi
            limits:
              cpu: 2000m
              memory: 4Gi
          livenessProbe:
            httpGet:
              path: /service/rest/v1/status
              port: nexus-ui
            initialDelaySeconds: 180
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 6
          readinessProbe:
            httpGet:
              path: /service/rest/v1/status
              port: nexus-ui
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
      volumes:
        - name: nexus-data
          persistentVolumeClaim:
            claimName: nexus-data
---
# Main Nexus UI Service
apiVersion: v1
kind: Service
metadata:
  name: nexus
  namespace: registry
  labels:
    app: nexus
spec:
  type: ClusterIP
  ports:
    - port: 8081
      targetPort: nexus-ui
      protocol: TCP
      name: nexus-ui
  selector:
    app: nexus
---
# Docker Registry Service (hosted images - push/pull your own images)
apiVersion: v1
kind: Service
metadata:
  name: nexus-docker
  namespace: registry
  labels:
    app: nexus
spec:
  type: ClusterIP
  ports:
    - port: 5000
      targetPort: docker-hosted
      protocol: TCP
      name: docker
  selector:
    app: nexus
---
# Docker Proxy Service (cached images from Docker Hub)
apiVersion: v1
kind: Service
metadata:
  name: nexus-docker-proxy
  namespace: registry
  labels:
    app: nexus
spec:
  type: ClusterIP
  ports:
    - port: 5001
      targetPort: docker-proxy
      protocol: TCP
      name: docker-proxy
  selector:
    app: nexus
---
# NPM Registry Service
apiVersion: v1
kind: Service
metadata:
  name: nexus-npm
  namespace: registry
  labels:
    app: nexus
spec:
  type: ClusterIP
  ports:
    - port: 8082
      targetPort: npm
      protocol: TCP
      name: npm
  selector:
    app: nexus
---
# Nexus UI IngressRoute
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: nexus
  namespace: registry
spec:
  entryPoints:
    - web
  routes:
    - match: Host(`nexus.talos00`)
      kind: Rule
      services:
        - name: nexus
          port: 8081
---
# Middleware for Docker Registry - allows large uploads and proper chunked transfer handling
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: docker-registry-buffering
  namespace: registry
spec:
  buffering:
    maxRequestBodyBytes: 0  # 0 = unlimited
    maxResponseBodyBytes: 0  # 0 = unlimited
    memRequestBodyBytes: 2097152  # 2MB
    memResponseBodyBytes: 2097152  # 2MB
---
# Docker Registry IngressRoute (for pushing/pulling images)
# Fix: Added PathPrefix for Docker registry API version routing
# See: https://stackoverflow.com/questions/62773097/nexus-3-as-docker-registry-behind-traefik-v-2-pushing-fails
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: nexus-docker
  namespace: registry
spec:
  entryPoints:
    - web
  routes:
    # Handle /v2/ and /v1/ Docker API paths explicitly
    - match: Host(`registry.talos00`) && PathPrefix(`/v2`)
      kind: Rule
      middlewares:
        - name: docker-registry-buffering
      services:
        - name: nexus-docker
          port: 5000
    - match: Host(`registry.talos00`) && PathPrefix(`/v1`)
      kind: Rule
      middlewares:
        - name: docker-registry-buffering
      services:
        - name: nexus-docker
          port: 5000
    # Fallback for other paths (catalog, etc)
    - match: Host(`registry.talos00`)
      kind: Rule
      middlewares:
        - name: docker-registry-buffering
      services:
        - name: nexus-docker
          port: 5000
---
# Docker Hub Proxy IngressRoute (for cached Docker Hub images)
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: nexus-docker-proxy
  namespace: registry
spec:
  entryPoints:
    - web
  routes:
    - match: Host(`docker-proxy.talos00`)
      kind: Rule
      services:
        - name: nexus-docker-proxy
          port: 5001
---
# NPM Registry IngressRoute
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: nexus-npm
  namespace: registry
spec:
  entryPoints:
    - web
  routes:
    - match: Host(`npm.talos00`)
      kind: Rule
      services:
        - name: nexus-npm
          port: 8082

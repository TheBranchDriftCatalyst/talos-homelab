---
# Velero - Kubernetes Backup & Disaster Recovery
# Docs: https://velero.io/docs/
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: vmware-tanzu
  namespace: backup
spec:
  interval: 1h
  url: https://vmware-tanzu.github.io/helm-charts
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: velero
  namespace: backup
spec:
  interval: 30m
  chart:
    spec:
      chart: velero
      version: '11.2.0'
      sourceRef:
        kind: HelmRepository
        name: vmware-tanzu
        namespace: backup
      interval: 12h
  install:
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
    cleanupOnFail: true
  values:
    # Disable internal CRD upgrade job (Flux handles CRDs)
    upgradeCRDs: false

    # AWS plugin for S3-compatible storage
    initContainers:
      - name: velero-plugin-for-aws
        image: velero/velero-plugin-for-aws:v1.11.1
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - mountPath: /target
            name: plugins

    # Use Kopia for file-system backups (replacement for Restic)
    # More efficient, better deduplication
    configuration:
      # S3-compatible storage (MinIO)
      backupStorageLocation:
        - name: default
          provider: aws
          bucket: velero
          config:
            region: minio
            s3ForcePathStyle: "true"
            s3Url: http://minio.minio.svc.cluster.local
          credential:
            name: velero-s3-credentials
            key: cloud

      # Volume snapshot location (not using CSI snapshots)
      volumeSnapshotLocation: []

      # Use Kopia for file-system backups
      uploaderType: kopia

      # Default backup TTL
      defaultBackupTTL: 720h  # 30 days

    # Credentials for S3
    credentials:
      useSecret: true
      name: velero-s3-credentials
      secretContents:
        cloud: |
          [default]
          aws_access_key_id=minio
          aws_secret_access_key=minio123

    # Node agent (runs on each node for PVC backups)
    deployNodeAgent: true
    nodeAgent:
      resources:
        requests:
          cpu: 100m
          memory: 128Mi

    # Velero server resources
    resources:
      requests:
        cpu: 100m
        memory: 128Mi

    # Prometheus metrics
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        additionalLabels:
          release: prometheus

    # Schedules for automated backups
    schedules:
      # Daily backup of all namespaces (except system)
      daily-all:
        disabled: false
        schedule: "0 2 * * *"  # 2 AM daily
        useOwnerReferencesInBackup: false
        template:
          ttl: "720h"  # 30 days
          includedNamespaces:
            - media
            - scratch
            - arr-stack
            - home-automation
          excludedResources:
            - events
            - pods
          storageLocation: default
          snapshotVolumes: false
          defaultVolumesToFsBackup: true

      # Weekly full backup including PVCs
      weekly-full:
        disabled: false
        schedule: "0 3 * * 0"  # 3 AM Sunday
        useOwnerReferencesInBackup: false
        template:
          ttl: "2160h"  # 90 days
          includedNamespaces:
            - "*"
          excludedNamespaces:
            - kube-system
            - kube-public
            - kube-node-lease
            - flux-system
          excludedResources:
            - events
          storageLocation: default
          snapshotVolumes: false
          defaultVolumesToFsBackup: true

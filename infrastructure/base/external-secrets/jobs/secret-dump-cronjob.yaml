---
# ServiceAccount for ESO secret dump job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: eso-secret-dump
  namespace: external-secrets
---
# ClusterRole with read permissions for ESO resources
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: eso-secret-dump-reader
rules:
  # External Secrets Operator CRDs
  - apiGroups: ["external-secrets.io"]
    resources:
      - externalsecrets
      - secretstores
      - clustersecretstores
    verbs: ["get", "list"]
  # Pods (for checking 1Password Connect status)
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]
---
# ClusterRoleBinding to grant the ServiceAccount cluster-wide read access
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: eso-secret-dump-reader-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: eso-secret-dump-reader
subjects:
  - kind: ServiceAccount
    name: eso-secret-dump
    namespace: external-secrets
---
# CronJob to dump ESO resources and vault information
apiVersion: batch/v1
kind: CronJob
metadata:
  name: eso-secret-dump
  namespace: external-secrets
  labels:
    app: eso-secret-dump
    component: diagnostics
spec:
  # Run every 6 hours (suspended by default - manual trigger only)
  schedule: "0 */6 * * *"
  suspend: true
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    metadata:
      labels:
        app: eso-secret-dump
        component: diagnostics
    spec:
      ttlSecondsAfterFinished: 86400  # Keep job for 24 hours
      backoffLimit: 2
      template:
        metadata:
          labels:
            app: eso-secret-dump
            component: diagnostics
        spec:
          serviceAccountName: eso-secret-dump
          restartPolicy: OnFailure
          containers:
            - name: dump
              image: bitnami/kubectl:latest
              imagePullPolicy: IfNotPresent
              command:
                - /bin/sh
                - -c
                - |
                  #!/bin/sh
                  set -e

                  echo "=========================================="
                  echo "=== ESO Secret Dump ==="
                  echo "Date: $(date)"
                  echo "=========================================="
                  echo ""

                  echo "=== External Secrets (All Namespaces) ==="
                  kubectl get externalsecrets -A -o wide || echo "Failed to get ExternalSecrets"
                  echo ""
                  echo "--- Detailed YAML ---"
                  kubectl get externalsecrets -A -o yaml || echo "Failed to get ExternalSecrets YAML"
                  echo ""

                  echo "=== Secret Stores (Namespaced) ==="
                  kubectl get secretstores -A -o wide || echo "Failed to get SecretStores"
                  echo ""
                  echo "--- Detailed YAML ---"
                  kubectl get secretstores -A -o yaml || echo "Failed to get SecretStores YAML"
                  echo ""

                  echo "=== Cluster Secret Stores ==="
                  kubectl get clustersecretstores -o wide || echo "Failed to get ClusterSecretStores"
                  echo ""
                  echo "--- Detailed YAML ---"
                  kubectl get clustersecretstores -o yaml || echo "Failed to get ClusterSecretStores YAML"
                  echo ""

                  echo "=== 1Password Connect Status ==="
                  echo "--- Pods ---"
                  kubectl get pods -n external-secrets -l app=onepassword-connect || echo "No 1Password Connect pods found"
                  echo ""
                  echo "--- Services ---"
                  kubectl get svc -n external-secrets -l app=onepassword-connect || echo "No 1Password Connect services found"
                  echo ""

                  echo "=== ESO Operator Status ==="
                  kubectl get pods -n external-secrets -l app.kubernetes.io/name=external-secrets || echo "No ESO operator pods found"
                  echo ""

                  echo "=========================================="
                  echo "=== Dump Complete ==="
                  echo "=========================================="
              resources:
                requests:
                  cpu: 10m
                  memory: 32Mi
                limits:
                  cpu: 100m
                  memory: 128Mi
              securityContext:
                runAsNonRoot: true
                runAsUser: 1001
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                    - ALL
          securityContext:
            fsGroup: 1001
            seccompProfile:
              type: RuntimeDefault

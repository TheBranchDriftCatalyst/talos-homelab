---
apiVersion: batch/v1
kind: Job
metadata:
  name: onepassword-debug
  namespace: external-secrets
  labels:
    app: onepassword-debug
spec:
  ttlSecondsAfterFinished: 300  # Auto-cleanup after 5 minutes
  backoffLimit: 2
  template:
    metadata:
      labels:
        app: onepassword-debug
        job-name: onepassword-debug
    spec:
      restartPolicy: Never
      containers:
        - name: debug
          image: curlimages/curl:8.5.0
          command:
            - /bin/sh
            - -c
            - |
              set -e

              echo "=============================================="
              echo "üîç 1Password Connect API Debug"
              echo "=============================================="
              echo ""

              # Environment info
              echo "üìç Environment:"
              echo "  Connect Host: ${OP_CONNECT_HOST}"
              echo "  Namespace: ${NAMESPACE}"
              echo ""

              # Check Connect API health
              echo "üè• Checking 1Password Connect health..."
              if curl -sf "${OP_CONNECT_HOST}/health" > /dev/null; then
                echo "  ‚úì Connect API is healthy"
              else
                echo "  ‚úó Connect API health check failed"
                exit 1
              fi
              echo ""

              # List available vaults
              echo "üóÑÔ∏è  Available Vaults:"
              echo "----------------------------------------"
              VAULTS=$(curl -sf -H "Authorization: Bearer ${OP_CONNECT_TOKEN}" \
                "${OP_CONNECT_HOST}/v1/vaults" || echo "[]")

              if [ "${VAULTS}" = "[]" ]; then
                echo "  ‚úó No vaults found or authentication failed"
                exit 1
              fi

              echo "${VAULTS}" | sed 's/},{/},\n{/g' | while IFS= read -r vault; do
                VAULT_ID=$(echo "${vault}" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
                VAULT_NAME=$(echo "${vault}" | grep -o '"name":"[^"]*"' | cut -d'"' -f4)
                [ -n "${VAULT_ID}" ] && echo "  üì¶ ${VAULT_NAME} (ID: ${VAULT_ID})"
              done
              echo ""

              # List items in the configured vault
              echo "üìù Items in vault '${VAULT_NAME}':"
              echo "----------------------------------------"

              # Try to get vault ID from vault name
              VAULT_ID=$(echo "${VAULTS}" | grep -o '"id":"[^"]*","name":"'"${VAULT_NAME}"'"' | cut -d'"' -f4)

              if [ -z "${VAULT_ID}" ]; then
                echo "  ‚ö†Ô∏è  Could not find vault '${VAULT_NAME}'"
                echo "  Available vaults listed above"
                exit 1
              fi

              ITEMS=$(curl -sf -H "Authorization: Bearer ${OP_CONNECT_TOKEN}" \
                "${OP_CONNECT_HOST}/v1/vaults/${VAULT_ID}/items" || echo "[]")

              if [ "${ITEMS}" = "[]" ]; then
                echo "  (No items found in vault)"
              else
                echo "${ITEMS}" | sed 's/},{/},\n{/g' | while IFS= read -r item; do
                  ITEM_ID=$(echo "${item}" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
                  ITEM_TITLE=$(echo "${item}" | grep -o '"title":"[^"]*"' | cut -d'"' -f4)
                  [ -n "${ITEM_ID}" ] && echo "  ‚Ä¢ ${ITEM_TITLE} (ID: ${ITEM_ID})"
                done
              fi
              echo ""

              echo "=============================================="
              echo "‚úì Debug complete"
              echo "=============================================="
          env:
            - name: OP_CONNECT_HOST
              value: "http://onepassword-connect.external-secrets.svc.cluster.local:8080"
            - name: OP_CONNECT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: onepassword-connect-token
                  key: token
            - name: VAULT_NAME
              value: "catalyst-eso"
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 100m
              memory: 64Mi

---
apiVersion: batch/v1
kind: Job
metadata:
  name: onepassword-debug
  namespace: external-secrets
  labels:
    app: onepassword-debug
spec:
  ttlSecondsAfterFinished: 300 # Auto-cleanup after 5 minutes
  backoffLimit: 2
  template:
    metadata:
      labels:
        app: onepassword-debug
        job-name: onepassword-debug
    spec:
      restartPolicy: Never
      containers:
        - name: debug
          image: alpine:latest
          command:
            - /bin/sh
            - -c
            - |
              set -e

              # Install curl and jq
              apk add --no-cache curl jq

              TOKEN="${OP_CONNECT_TOKEN}"
              CONNECT_HOST="${OP_CONNECT_HOST}"

              echo "=================================================="
              echo "üîç 1Password Connect API Debug"
              echo "=================================================="
              echo ""

              # Check Connect API health
              echo "üè• Health Check:"
              if curl -sf "${CONNECT_HOST}/health" > /dev/null; then
                echo "  ‚úì Connect API is healthy"
              else
                echo "  ‚úó Connect API health check failed"
                exit 1
              fi
              echo ""

              # List all vaults
              echo "üìÅ Available Vaults:"
              echo "--------------------------------------------------"
              VAULTS=$(curl -s -H "Authorization: Bearer ${TOKEN}" \
                "${CONNECT_HOST}/v1/vaults")

              echo "${VAULTS}" | jq -r '.[] | "  üì¶ \(.name) (ID: \(.id))"'
              echo ""

              # Get vault ID for the configured vault
              VAULT_ID=$(echo "${VAULTS}" | jq -r ".[] | select(.name == \"${VAULT_NAME}\") | .id")

              if [ -z "${VAULT_ID}" ]; then
                echo "‚ö†Ô∏è  Vault '${VAULT_NAME}' not found"
                echo "Available vaults listed above"
                exit 1
              fi

              echo "üîç Items in '${VAULT_NAME}' vault (ID: ${VAULT_ID}):"
              echo "--------------------------------------------------"

              # List all items in the vault
              ITEMS=$(curl -s -H "Authorization: Bearer ${TOKEN}" \
                "${CONNECT_HOST}/v1/vaults/${VAULT_ID}/items")

              echo "${ITEMS}" | jq -r '.[] | "  üìÑ \(.title) (ID: \(.id))"'
              echo ""

              # For each item, fetch full details including secrets
              echo "üîì Secret Values:"
              echo "--------------------------------------------------"

              for ITEM_ID in $(echo "${ITEMS}" | jq -r '.[].id'); do
                ITEM_DETAILS=$(curl -s -H "Authorization: Bearer ${TOKEN}" \
                  "${CONNECT_HOST}/v1/vaults/${VAULT_ID}/items/${ITEM_ID}")

                ITEM_TITLE=$(echo "${ITEM_DETAILS}" | jq -r '.title')
                echo ""
                echo "üìå ${ITEM_TITLE}:"

                # Extract all fields with their values
                echo "${ITEM_DETAILS}" | jq -r '
                  .fields[]? |
                  select(.value != null and .value != "") |
                  "  \(.label // .id): \(.value)"
                '
              done

              echo ""
              echo "=================================================="
              echo "‚úÖ Debug complete"
              echo "=================================================="
          env:
            - name: OP_CONNECT_HOST
              value: 'http://onepassword-connect.external-secrets.svc.cluster.local:8080'
            - name: OP_CONNECT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: onepassword-connect-token
                  key: token
            - name: VAULT_NAME
              value: 'catalyst-eso'
          resources:
            requests:
              cpu: 10m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi

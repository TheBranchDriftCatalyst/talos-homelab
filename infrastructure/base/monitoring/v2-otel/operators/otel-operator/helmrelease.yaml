---
# OpenTelemetry Operator
# Provides CRDs: OpenTelemetryCollector, Instrumentation
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: open-telemetry
  namespace: monitoring
spec:
  interval: 1h
  url: https://open-telemetry.github.io/opentelemetry-helm-charts
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: opentelemetry-operator
  namespace: monitoring
spec:
  interval: 30m
  timeout: 15m  # Allow extra time for informer sync during startup
  chart:
    spec:
      chart: opentelemetry-operator
      version: '0.74.0'
      sourceRef:
        kind: HelmRepository
        name: open-telemetry
        namespace: monitoring
      interval: 12h
  install:
    crds: Create
    remediation:
      retries: 3
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
  values:
    # Limit namespace scope to reduce informer sync load
    # Bug workaround: single namespace needs trailing comma
    # See: https://github.com/open-telemetry/opentelemetry-operator/issues/2667
    env:
      ENABLE_WEBHOOKS: "true"
      WATCH_NAMESPACE: "monitoring,media,default,"

    # Manager configuration
    manager:
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
      # Collector image (for CRD-created collectors)
      collectorImage:
        repository: otel/opentelemetry-collector-contrib
        tag: '0.115.0'
      # Instrumentation auto-inject support
      autoInstrumentationImage:
        python:
          repository: ghcr.io/open-telemetry/opentelemetry-operator/autoinstrumentation-python
          tag: '0.48b0'
        nodejs:
          repository: ghcr.io/open-telemetry/opentelemetry-operator/autoinstrumentation-nodejs
          tag: '0.52.0'
        java:
          repository: ghcr.io/open-telemetry/opentelemetry-operator/autoinstrumentation-java
          tag: '2.8.0'
        go:
          repository: ghcr.io/open-telemetry/opentelemetry-operator/autoinstrumentation-go
          tag: 'v0.14.0-alpha'
      # Disable ServiceMonitor creation (we manage separately)
      serviceMonitor:
        enabled: false

    # Enable admission webhooks
    admissionWebhooks:
      certManager:
        enabled: false # Use self-signed if no cert-manager
      autoGenerateCert:
        enabled: true

---
# Mimir datasource - OTLP Metrics (primary for application telemetry)
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDatasource
metadata:
  name: mimir
  namespace: monitoring
spec:
  instanceSelector:
    matchLabels:
      dashboards: 'grafana'
  datasource:
    name: Mimir
    type: prometheus
    uid: mimir
    access: proxy
    url: http://mimir-nginx.monitoring.svc:80/prometheus
    isDefault: true
    jsonData:
      httpMethod: POST
    editable: false
---
# Loki datasource - Logs
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDatasource
metadata:
  name: loki-v2
  namespace: monitoring
spec:
  instanceSelector:
    matchLabels:
      dashboards: 'grafana'
  datasource:
    name: Loki
    type: loki
    uid: loki-v2
    access: proxy
    url: http://loki.monitoring.svc:3100
    isDefault: false
    jsonData:
      maxLines: 1000
      timeout: 60
    editable: false
---
# Tempo datasource - Traces
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDatasource
metadata:
  name: tempo
  namespace: monitoring
spec:
  instanceSelector:
    matchLabels:
      dashboards: 'grafana'
  datasource:
    name: Tempo
    type: tempo
    access: proxy
    url: http://tempo.monitoring.svc:3200
    isDefault: false
    jsonData:
      httpMethod: GET
      # Trace to logs correlation
      tracesToLogsV2:
        datasourceUid: loki-v2
        spanStartTimeShift: '-1h'
        spanEndTimeShift: '1h'
        filterByTraceID: true
        filterBySpanID: true
        customQuery: true
        query: '{exporter="OTLP"} | trace_id="$${__trace.traceId}"'
      # Trace to metrics correlation (using Mimir for OTLP metrics)
      tracesToMetrics:
        datasourceUid: mimir
        spanStartTimeShift: '-1h'
        spanEndTimeShift: '1h'
        tags:
          - key: service.name
            value: service
          - key: job
      # Service graph
      serviceMap:
        datasourceUid: mimir
      # Node graph
      nodeGraph:
        enabled: true
      # Search with Loki
      lokiSearch:
        datasourceUid: loki-v2
    editable: false

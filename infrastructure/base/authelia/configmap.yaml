---
apiVersion: v1
kind: ConfigMap
metadata:
  name: authelia-config
  namespace: authelia
data:
  configuration.yml: |
    ---
    # Authelia configuration
    # https://www.authelia.com/configuration/

    theme: dark

    # Server configuration
    server:
      address: 'tcp://:9091'
      buffers:
        read: 4096
        write: 4096

    # Logging
    log:
      level: info
      format: text

    # TOTP (Time-based One-Time Password) configuration
    totp:
      issuer: knowledgedump.space
      period: 30
      skew: 1

    # WebAuthn configuration
    webauthn:
      display_name: Knowledgedump

    # Authentication backend - file based
    authentication_backend:
      file:
        path: /config/users_database.yml
        password:
          algorithm: argon2id
          iterations: 3
          memory: 65536
          parallelism: 4
          key_length: 32
          salt_length: 16

    # Access control rules
    access_control:
      default_policy: deny
      rules:
        # Allow public access to Authelia itself
        - domain: auth.knowledgedump.space
          policy: bypass

        # Two-factor for admin domains
        - domain:
            - "*.knowledgedump.space"
          policy: two_factor
          subject:
            - "group:admins"

        # One-factor for regular users
        - domain:
            - "*.knowledgedump.space"
          policy: one_factor
          subject:
            - "group:users"

    # Session configuration
    session:
      name: authelia_session
      same_site: lax
      expiration: 1h
      inactivity: 5m
      remember_me: 1M
      cookies:
        - domain: knowledgedump.space
          authelia_url: https://auth.knowledgedump.space
          default_redirection_url: https://knowledgedump.space

    # Regulation - brute force protection
    regulation:
      max_retries: 3
      find_time: 2m
      ban_time: 5m

    # Storage backend - local SQLite
    storage:
      local:
        path: /data/db.sqlite3

    # Notifier - filesystem for now (can add SMTP later)
    notifier:
      filesystem:
        filename: /data/notification.txt

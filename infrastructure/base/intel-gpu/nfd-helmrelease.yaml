---
# Node Feature Discovery - Auto-detect and label node hardware features
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: node-feature-discovery
  namespace: flux-system
spec:
  interval: 24h
  url: https://kubernetes-sigs.github.io/node-feature-discovery/charts
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: node-feature-discovery
  namespace: node-feature-discovery
spec:
  interval: 30m
  chart:
    spec:
      chart: node-feature-discovery
      version: "0.17.*"  # Use latest 0.17.x
      sourceRef:
        kind: HelmRepository
        name: node-feature-discovery
        namespace: flux-system
      interval: 12h
  install:
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
  values:
    # Master component (runs on control plane)
    master:
      replicaCount: 1
      resources:
        requests:
          cpu: 10m
          memory: 64Mi
        limits:
          cpu: 100m
          memory: 128Mi

    # Worker component (runs on all nodes as DaemonSet)
    worker:
      resources:
        requests:
          cpu: 5m
          memory: 32Mi
        limits:
          cpu: 50m
          memory: 64Mi
      config:
        sources:
          cpu:
            cpuid:
              # Exclude common features to reduce label noise
              attributeBlacklist:
                - BMI1
                - BMI2
                - CLMUL
                - CMOV
                - CX16
                - ERMS
                - F16C
                - HTT
                - LZCNT
                - MMX
                - MMXEXT
                - NX
                - POPCNT
                - RDRAND
                - RDSEED
                - RDTSCP
                - SSE
                - SSE2
                - SSE3
                - SSE4
                - SSE42
                - SSSE3
          pci:
            deviceClassWhitelist:
              - "0200"  # Network controller
              - "03"    # Display controller (GPU)
              - "0300"  # VGA controller
              - "0302"  # 3D controller
              - "12"    # Processing accelerators
            deviceLabelFields:
              - class
              - vendor
              - device

    # Garbage collector for stale labels
    gc:
      enable: true
      replicaCount: 1
      interval: 1h

    # Prometheus metrics
    prometheus:
      enable: true

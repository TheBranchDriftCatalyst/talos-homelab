---
# Intel NFD Rules - detect Intel GPUs and label nodes automatically
# These rules tell NFD how to identify Intel GPU hardware
apiVersion: nfd.k8s-sigs.io/v1alpha1
kind: NodeFeatureRule
metadata:
  name: intel-gpu-device
  namespace: node-feature-discovery
spec:
  rules:
    - name: 'intel.gpu'
      labels:
        'intel.feature.node.kubernetes.io/gpu': 'true'
      matchFeatures:
        - feature: pci.device
          matchExpressions:
            vendor: {op: In, value: ['8086']}  # Intel vendor ID
            class: {op: In, value: ['0300', '0380']}  # VGA/Display controller
---
# Intel GPU Device Plugin Custom Resource
# Deploys the actual GPU plugin to nodes with Intel GPUs
apiVersion: deviceplugin.intel.com/v1
kind: GpuDevicePlugin
metadata:
  name: intel-gpu-plugin
  namespace: intel-device-plugins
spec:
  image: intel/intel-gpu-plugin:0.30.0
  initImage: intel/intel-gpu-initcontainer:0.30.0
  # Share GPU between multiple containers
  # Useful for transcoding where multiple streams may run
  # Set to 4 to allow Plex, Tdarr, Jellyfin + headroom
  sharedDevNum: 4
  # Log level: 1=error, 2=warning, 3=info, 4=debug
  logLevel: 2
  # Enable monitoring resource endpoint
  enableMonitoring: true
  # Only deploy on nodes with Intel GPU (labeled by NFD)
  nodeSelector:
    intel.feature.node.kubernetes.io/gpu: 'true'

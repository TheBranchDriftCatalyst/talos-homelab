apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Base resources
resources:
  - ../../base/namespaces
  - ../../base/storage
  - ../../base/traefik
  - ../../base/monitoring/kube-prometheus-stack

# Environment-specific configuration
namespace: media-prod

# ConfigMap for domain substitution
configMapGenerator:
  - name: domain-config
    literals:
      - DOMAIN=lab

# Patches for prod environment
patches:
  # Patch Grafana IngressRoute for prod domain
  - target:
      kind: IngressRoute
      name: grafana
      namespace: monitoring
    patch: |-
      - op: replace
        path: /spec/routes/0/match
        value: Host(`grafana.talos00`)

  # Patch Prometheus IngressRoute for prod domain
  - target:
      kind: IngressRoute
      name: prometheus
      namespace: monitoring
    patch: |-
      - op: replace
        path: /spec/routes/0/match
        value: Host(`prometheus.talos00`)

  # Patch Alertmanager IngressRoute for prod domain
  - target:
      kind: IngressRoute
      name: alertmanager
      namespace: monitoring
    patch: |-
      - op: replace
        path: /spec/routes/0/match
        value: Host(`alertmanager.talos00`)

# Variable substitutions for NFS storage
replacements:
  - source:
      kind: ConfigMap
      name: env-config
      fieldPath: data.SYNOLOGY_NFS_SERVER
    targets:
      - select:
          kind: StorageClass
          name: nfs-synology
        fieldPaths:
          - parameters.server
      - select:
          kind: PersistentVolume
          name: nfs-media
        fieldPaths:
          - spec.nfs.server
      - select:
          kind: PersistentVolume
          name: nfs-downloads
        fieldPaths:
          - spec.nfs.server

version: '3'

vars:
  IMAGE_NAME: localhost:5000/catalyst-dns-sync
  IMAGE_TAG: latest
  NAMESPACE: infrastructure

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  dev:
    desc: Start dev mode with Air hot reload (updates /etc/hosts)
    cmds:
      - echo "ğŸ”¥ Starting dev mode with Air hot reload..."
      - air

  build:
    desc: Build binary locally
    cmds:
      - echo "ğŸ”¨ Building binary..."
      - go build -o bin/catalyst-dns-sync ./cmd/controller
    generates:
      - bin/catalyst-dns-sync

  docker:
    desc: Build Docker image
    cmds:
      - echo "ğŸ³ Building Docker image..."
      - docker build -t {{.IMAGE_NAME}}:{{.IMAGE_TAG}} .

  push:
    desc: Push Docker image to local registry
    deps: [docker]
    cmds:
      - echo "ğŸ“¤ Pushing to local registry..."
      - docker push {{.IMAGE_NAME}}:{{.IMAGE_TAG}}

  deploy:
    desc: Deploy to Kubernetes cluster
    deps: [push]
    cmds:
      - echo "ğŸš€ Deploying to cluster..."
      - kubectl apply -k k8s/base/

  test:
    desc: Run unit tests
    cmds:
      - echo "ğŸ§ª Running tests..."
      - go test -v ./...

  test:watch:
    desc: Run tests in watch mode
    cmds:
      - echo "ğŸ§ª Running tests in watch mode..."
      - go test -v ./... -watch

  run-dev:
    desc: Run in dev mode (manual, without Air)
    cmds:
      - echo "ğŸ”§ Running in dev mode..."
      - go run ./cmd/controller --dev-mode

  install-air:
    desc: Install Air for hot reload
    cmds:
      - echo "ğŸ“¦ Installing Air..."
      - go install github.com/cosmtrek/air@latest

  init:
    desc: Initialize Go module (run once)
    cmds:
      - echo "ğŸ¬ Initializing Go module..."
      - go mod init github.com/talos-fix/catalyst-dns-sync
      - go mod tidy

  tidy:
    desc: Tidy Go modules
    cmds:
      - echo "ğŸ§¹ Tidying Go modules..."
      - go mod tidy

  clean:
    desc: Clean build artifacts
    cmds:
      - echo "ğŸ§¹ Cleaning build artifacts..."
      - rm -rf bin/ tmp/
      - go clean

  logs:
    desc: View logs from running pod
    cmds:
      - kubectl logs -n {{.NAMESPACE}} -l app=catalyst-dns-sync -f

  status:
    desc: Check deployment status
    cmds:
      - kubectl get deploy,svc,servicemonitor -n {{.NAMESPACE}} -l app=catalyst-dns-sync

  restart:
    desc: Restart deployment
    cmds:
      - kubectl rollout restart deploy/catalyst-dns-sync -n {{.NAMESPACE}}

  delete:
    desc: Delete deployment from cluster
    cmds:
      - kubectl delete -k k8s/base/

  metrics:
    desc: Port-forward and view metrics
    cmds:
      - echo "ğŸ“Š Forwarding metrics endpoint..."
      - echo "Visit http://localhost:8080/metrics"
      - kubectl port-forward -n {{.NAMESPACE}} svc/catalyst-dns-sync 8080:8080

  health:
    desc: Port-forward and check health endpoints
    cmds:
      - echo "ğŸ¥ Forwarding health endpoint..."
      - echo "Liveness: curl http://localhost:8081/healthz"
      - echo "Readiness: curl http://localhost:8081/readyz"
      - kubectl port-forward -n {{.NAMESPACE}} svc/catalyst-dns-sync 8081:8081

  test-ingress:
    desc: Create a test IngressRoute
    cmds:
      - |
        kubectl apply -f - <<EOF
        apiVersion: traefik.io/v1alpha1
        kind: IngressRoute
        metadata:
          name: test-app
          namespace: default
        spec:
          routes:
          - match: Host(\`test.talos00\`)
            services:
            - name: whoami
              port: 80
        EOF
      - echo "âœ… Test IngressRoute created. Check DNS with: dig @192.168.1.54 test.talos00"

  test-ingress:delete:
    desc: Delete test IngressRoute
    cmds:
      - kubectl delete ingressroute test-app -n default
      - echo "ğŸ—‘ï¸  Test IngressRoute deleted. Verify DNS removed with: dig @192.168.1.54 test.talos00"

  fmt:
    desc: Format Go code
    cmds:
      - echo "ğŸ¨ Formatting code..."
      - go fmt ./...

  lint:
    desc: Lint Go code
    cmds:
      - echo "ğŸ” Linting code..."
      - golangci-lint run ./...

  vet:
    desc: Vet Go code
    cmds:
      - echo "ğŸ”¬ Vetting code..."
      - go vet ./...

  check:
    desc: Run all checks (fmt, vet, test)
    cmds:
      - task: fmt
      - task: vet
      - task: test

  # Local /etc/hosts management (legacy support)
  hosts:update:
    desc: Update /etc/hosts using update-hosts.sh script
    dir: ..
    cmds:
      - ./scripts/update-hosts.sh

  hosts:update:dry-run:
    desc: Dry run of /etc/hosts update
    dir: ..
    cmds:
      - ./scripts/update-hosts.sh --dry-run

  # Development workflow helpers
  dev:setup:
    desc: Complete development setup (install Air, init module)
    cmds:
      - task: install-air
      - task: init
      - echo "âœ… Dev setup complete! Run 'task dev' to start."

  prod:deploy:
    desc: Full production deployment (build, push, deploy, status)
    cmds:
      - task: docker
      - task: push
      - task: deploy
      - sleep 5
      - task: status

  # Debugging helpers
  debug:pod:
    desc: Exec into running pod
    cmds:
      - kubectl exec -it -n {{.NAMESPACE}} deploy/catalyst-dns-sync -- /bin/sh

  debug:describe:
    desc: Describe deployment
    cmds:
      - kubectl describe deploy -n {{.NAMESPACE}} catalyst-dns-sync

  debug:events:
    desc: Show events in namespace
    cmds:
      - kubectl get events -n {{.NAMESPACE}} --sort-by='.lastTimestamp'
